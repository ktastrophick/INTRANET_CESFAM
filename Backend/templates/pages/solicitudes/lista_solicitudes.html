{% extends "base/base.html" %}
{% load static %}

{% block title %}Solicitudes — Intranet CESFAM{% endblock %}

{% block extra_css %}
  <style>
    .solicitud-container{
      background:white;
      border-radius:16px;
      box-shadow:0 2px 8px rgba(0,0,0,0.1);
      padding:2rem;
      margin:0 auto;
      max-width:1200px;
    }

    .solicitud-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:1.5rem;
    }

    .solicitud-header h2{
      font-size:1.5rem;
      font-weight:700;
      color:#1a1a1a;
    }

    .upload-btn{
      background:linear-gradient(135deg,#66b2ff 0%,#7fffd4 100%);
      color:#fff;
      border:none;
      padding:0.75rem 1.5rem;
      border-radius:10px;
      cursor:pointer;
      font-weight:500;
      transition:transform 0.3s,opacity 0.3s;
    }

    .upload-btn:hover{opacity:0.9;transform:translateY(-2px);}

    .filter-container{
      display:flex;
      gap:1rem;
      flex-wrap:wrap;
      margin-bottom:1.5rem;
    }

    .filter-container input,
    .filter-container select{
      padding:0.6rem;
      border:1px solid #ccc;
      border-radius:8px;
      font-size:0.9rem;
      flex:1;
      min-width:180px;
    }

    table{
      width:100%;
      border-collapse:collapse;
      margin-top:1rem;
      border-radius:10px;
      overflow:hidden;
    }

    th,td{
      padding:0.8rem;
      text-align:left;
      border-bottom:1px solid #eee;
    }

    th{
      background:#2563eb;
      color:white;
      font-weight:600;
    }

    tr:hover{background:#f5faff;}

    td.status-Pendiente{color:#ff9800;font-weight:600;}
    td.status-Aprobado{color:#4caf50;font-weight:600;}
    td.status-Rechazado{color:#dc2626;font-weight:600;}
    .action-btn {
      background: none;
      border: none;
      cursor: pointer;
      margin-right: 6px;
      font-size: 1rem;
      padding: 4px 6px;
      border-radius: 6px;
      transition: 0.2s;
    }

    .action-btn.download { color: #4caf50; }
    .action-btn.download:hover { background: rgba(76,175,80,0.1); }

    .action-btn.message { color: #2196f3; }
    .action-btn.message:hover { background: rgba(33,150,243,0.1); }

    .action-btn.delete { color: #dc2626; }
    .action-btn.delete:hover { background: rgba(220,38,38,0.1); }
  </style>
{% endblock %}

{% block content %}
  <section class="page-content">
    <div class="solicitud-container">
      <div class="solicitud-header">
        <h2>Solicitudes de Permiso / Vacaciones</h2>
        <a href="{% url 'form_solicitud' %}">
          <button class="upload-btn"><i class="fa-solid fa-plus"></i> Nueva solicitud</button>
        </a>
      </div>

      <div class="filter-container">
        <input type="text" id="filterName" placeholder="Buscar por tipo o motivo..." onkeyup="aplicarFiltros()">
        <input type="date" id="filterFecha" onchange="aplicarFiltros()">
        <select id="filterEstado" onchange="aplicarFiltros()">
          <option value="">Todos los estados</option>
          <option value="Pendiente">Pendiente</option>
          <option value="Aprobado">Aprobado</option>
          <option value="Rechazado">Rechazado</option>
        </select>
      </div>

<table id="solicitudesTable">
  <thead>
    <tr>
      <th>Tipo</th>
      <th>Fecha Inicio</th>
      <th>Fecha Fin</th>
      <th>Estado Jefatura</th>
      <th>Estado Administración</th>
      <th>Acciones</th> <!-- Nueva columna -->
    </tr>
  </thead>
    <tbody>
        {% for s in solicitudes %}
        <tr>
          <td>{{ s.tipo_solicitud.nombre }}</td>
          <td>{{ s.dia_inicio }}</td>
          <td>{{ s.dia_fin }}</td>

          <td>
            {{ s.descripcion|default:"---" }}
          </td>

          <td class="status-{{ s.estado_solicitud.nombre|default:'SinEstado' }}">
            {{ s.estado_solicitud.nombre|default:"---" }}
          </td>

          <td>
            {% if s.estado_solicitud.nombre == "Pendiente" %}
              <span class="status-Pendiente">Pendiente</span>
            {% elif s.estado_solicitud.nombre == "Aprobado" %}
              <span class="status-Aprobado">Aprobado</span>
            {% elif s.estado_solicitud.nombre == "Rechazado" %}
              <span class="status-Rechazado">Rechazado</span>
            {% else %}
              ---
            {% endif %}
          </td>

          <td>
            <!-- Descargar -->
            <button class="action-btn download" title="Descargar">
              <i class="fa-solid fa-download"></i>
            </button>

            <!-- Aprobación Director -->
            {% if rol_usuario == "Director" and s.estado_solicitud.nombre == "Pendiente" %}
              <button class="action-btn" style="color:#4caf50;" title="Aprobar">
                <i class="fa-solid fa-check"></i>
              </button>
              <button class="action-btn" style="color:#dc2626;" title="Rechazar">
                <i class="fa-solid fa-xmark"></i>
              </button>
            {% endif %}

            <!-- Editar -->
            <a href="{% url 'editar_solicitud' s.id_solicitud %}" class="action-btn" style="color:#2196f3;">
                <i class="fa-solid fa-pen"></i>
            </a>

            <!-- Eliminar -->
            <a href="{% url 'eliminar_solicitud' s.id_solicitud %}" class="action-btn delete">
                <i class="fa-solid fa-trash"></i>
            </a>
          </td>
        </tr>

        {% empty %}
        <tr>
          <td colspan="7" style="text-align:center; padding:15px;">
            No hay solicitudes registradas.
          </td>
        </tr>
        {% endfor %}
    </tbody>


</table>

    </div>
  </section>
{% endblock %}

{% block extra_js %}
  <script>
    function aplicarFiltros(){
      const nombre = document.getElementById("filterName").value.toLowerCase();
      const fecha = document.getElementById("filterFecha").value;
      const estado = document.getElementById("filterEstado").value;

      document.querySelectorAll("#solicitudesTable tbody tr").forEach(fila=>{
        const tipo = fila.children[0].textContent.toLowerCase();
        const inicio = fila.children[1].textContent;
        const fin = fila.children[2].textContent;
        const motivo = fila.children[3].textContent.toLowerCase();
        const estadoJef = fila.children[4].textContent;

        let mostrar = true;
        if(nombre && !tipo.includes(nombre) && !motivo.includes(nombre)) mostrar=false;
        if(fecha && !(fecha>=inicio && fecha<=fin)) mostrar=false;
        if(estado && estadoJef!==estado) mostrar=false;

        fila.style.display = mostrar ? "" : "none";
      });
    }
  </script>
{% endblock %}
