{% extends "base/base.html" %}
{% load static %}

{% block title %}Calendario General — Intranet CESFAM{% endblock %}

{% block extra_css %} 
    <link rel="stylesheet" href="{% static 'css/calendario.css' %}">
    <style>
        :root {
            --primary-color: #0B2C4A;
            --secondary-color: #8338ec;
            --vacation-color: #38b000;
            --admin-color: #ff006e;
            --warning-color: #ff9e00;
            --background-color: #f8f9fa;
            --card-color: #ffffff;
            --text-color: #333333;
            --border-color: #e0e0e0;
            --sidebar-width: 300px;
            --general-event-color: #FF6B6B;
            --personal-event-color: #3A8DFF;
        }
        
        .calendar-general-container {
            background-color: var(--background-color);
            min-height: calc(100vh - 60px);
            padding: 20px;
        }
        
        .page-header {
            margin-bottom: 30px;
        }
        
        .page-title {
            font-size: 2rem;
            color: var(--primary-color);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .page-description {
            color: #666;
            font-size: 1.1rem;
            max-width: 800px;
            margin-bottom: 20px;
        }
        
        /* Contenedor principal */
        .main-container {
            display: flex;
            gap: 30px;
        }
        
        @media (max-width: 1100px) {
            .main-container {
                flex-direction: column;
            }
        }
        
        /* Columna izquierda - Calendario */
        .calendar-column {
            flex: 2;
        }
        
        /* Columna derecha - Eventos */
        .events-column {
            flex: 1;
            min-width: 300px;
        }
        
        /* Calendario */
        .calendar-section {
            background-color: var(--card-color);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
        }
        
        .calendar-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .calendar-title i {
            font-size: 1.8rem;
        }
        
        .calendar-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .current-month {
            font-size: 1.4rem;
            font-weight: 600;
            color: var(--text-color);
        }
        
        .calendar-nav {
            display: flex;
            gap: 10px;
        }
        
        .nav-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .nav-btn:hover {
            background-color: #2a75f0;
        }
        
        .calendar-weekdays, .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }
        
        .calendar-weekdays div {
            text-align: center;
            font-weight: 600;
            padding: 10px 0;
            color: #666;
        }
        
        .calendar-days {
            margin-top: 10px;
        }
        
        .day {
            height: 100px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            background-color: white;
        }
        
        .day:hover {
            background-color: #f0f7ff;
            transform: scale(1.02);
        }
        
        .day-number {
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 1.1rem;
        }
        
        .day-events {
            flex: 1;
            overflow-y: auto;
            padding-right: 2px;
        }
        
        .day-event {
            font-size: 0.75rem;
            padding: 3px 6px;
            border-radius: 4px;
            margin-bottom: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: white;
            font-weight: 500;
        }
        
        .vacation-event {
            background-color: var(--vacation-color);
        }
        
        .admin-event {
            background-color: var(--admin-color);
        }
        
        .general-event {
            background-color: var(--general-event-color);
        }
        
        .personal-event {
            background-color: var(--personal-event-color);
        }
        
        .other-month {
            color: #ccc;
            background-color: #f9f9f9;
        }
        
        .today {
            background-color: rgba(58, 134, 255, 0.1);
            border: 2px solid var(--primary-color);
        }
        
        .day.has-events::after {
            content: '';
            position: absolute;
            top: 5px;
            right: 5px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--primary-color);
        }
        
        /* Sección de Todos los Eventos */
        .events-section {
            background-color: var(--card-color);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            height: fit-content;
        }
        
        .events-title {
            font-size: 1.3rem;
            margin-bottom: 20px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .events-title i {
            font-size: 1.5rem;
        }
        
        .events-list {
            max-height: 600px;
            overflow-y: auto;
            padding-right: 10px;
        }
        
        .event-item {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid var(--primary-color);
            background-color: #f9f9f9;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .event-item:hover {
            background-color: #f0f7ff;
            transform: translateY(-2px);
        }
        
        .event-item.general {
            border-left-color: var(--general-event-color);
            background-color: rgba(255, 107, 107, 0.1);
        }
        
        .event-item.personal {
            border-left-color: var(--personal-event-color);
            background-color: rgba(58, 141, 255, 0.1);
        }
        
        .event-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        
        .event-title {
            font-weight: 600;
            font-size: 1rem;
            color: var(--text-color);
        }
        
        .event-type {
            font-size: 0.8rem;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 500;
        }
        
        .event-type.general {
            background-color: var(--general-event-color);
            color: white;
        }
        
        .event-type.personal {
            background-color: var(--personal-event-color);
            color: white;
        }
        
        .event-date {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .event-description {
            font-size: 0.9rem;
            color: #555;
            margin-bottom: 10px;
        }
        
        .event-author {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8rem;
            color: #777;
        }
        
        .author-avatar {
            width: 25px;
            height: 25px;
            background: linear-gradient(135deg, var(--secondary-color), #6a28cc);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.8rem;
        }
        
        .no-events {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }
        
        .no-events i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #ddd;
        }
        
        /* Modal para eventos */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }
        
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal {
            background-color: white;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            transform: translateY(-20px);
            transition: transform 0.3s;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-overlay.active .modal {
            transform: translateY(0);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 1.5rem;
            color: var(--primary-color);
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #999;
            transition: color 0.2s;
        }
        
        .close-modal:hover {
            color: var(--text-color);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }
        
        .optional-label {
            color: #999;
            font-weight: normal;
        }
        
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 30px;
        }
        
        .btn {
            padding: 12px 25px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2a75f0;
        }
        
        .btn-secondary {
            background-color: #f0f0f0;
            color: var(--text-color);
        }
        
        .btn-secondary:hover {
            background-color: #e0e0e0;
        }
        
        /* Leyenda del calendario */
        .calendar-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }
        
        .legend-color {
            width: 15px;
            height: 15px;
            border-radius: 3px;
        }
        
        .legend-general {
            background-color: var(--general-event-color);
        }
        
        .legend-personal {
            background-color: var(--personal-event-color);
        }
        
        /* Botón agregar evento */
        .add-event-btn {
            position: absolute;
            bottom: 5px;
            right: 5px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.2s;
        }
        
        .add-event-btn:hover {
            transform: scale(1.1);
            background-color: #2a75f0;
        }
        
        .day:hover .add-event-btn {
            opacity: 1;
        }
        
        /* Scrollbar personalizado */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .calendar-general-container {
                padding: 15px;
            }
            
            .page-title {
                font-size: 1.5rem;
            }
            
            .day {
                height: 80px;
            }
            
            .calendar-section, .events-section {
                padding: 20px;
            }
        }
        
        @media (max-width: 480px) {
            .calendar-controls {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            
            .calendar-nav {
                align-self: flex-end;
            }
        }
    </style>
{% endblock %}

{% block content %}
<div class="calendar-general-container">
    <div class="page-header">
        <h1 class="page-title">
            <i class="fas fa-calendar-alt"></i> Calendario 
        </h1>
        <div class="text-muted small">
            <i class="bi bi-info-circle"></i> Ingrese los eventos en el calendario
        </div>
    </div>
    
    <div class="main-container">
        <!-- Columna izquierda: Calendario -->
        <div class="calendar-column">
            <section class="calendar-section">
                <div class="calendar-title">
                    <span><i class="far fa-calendar"></i> Calendario General</span>
                </div>
                
                <div class="calendar-controls">
                    <div class="current-month" id="current-month"></div>
                    <div class="calendar-nav">
                        <button class="nav-btn" id="prev-month">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <button class="nav-btn" id="today-btn">
                            Hoy
                        </button>
                        <button class="nav-btn" id="next-month">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
                
                <div class="calendar-weekdays">
                    <div>Lun</div>
                    <div>Mar</div>
                    <div>Mié</div>
                    <div>Jue</div>
                    <div>Vie</div>
                    <div>Sáb</div>
                    <div>Dom</div>
                </div>
                
                <div class="calendar-days" id="calendar-days">
                    <!-- Los días del calendario se generarán con JavaScript -->
                </div>
                
                <!-- Leyenda del calendario -->
                <div class="calendar-legend">
                    <div class="legend-item">
                        <div class="legend-color legend-general"></div>
                        <span>Eventos Generales</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-personal"></div>
                        <span>Eventos Personales</span>
                    </div>
                </div>
            </section>
        </div>
        
        <!-- Columna derecha: Todos los Eventos -->
        <div class="events-column">
            <section class="events-section">
                <div class="events-title">
                    <i class="fas fa-list-alt"></i> Todos los Eventos
                </div>
                
                <div class="events-list" id="events-list">
                    <!-- Los eventos se cargarán con JavaScript -->
                    <div class="no-events">
                        <i class="fas fa-calendar-times"></i>
                        <p>Cargando eventos...</p>
                    </div>
                </div>
            </section>
        </div>
    </div>
</div>

<!-- Modal para agregar/editar eventos -->
<div class="modal-overlay" id="event-modal">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title" id="modal-title">Agregar Evento</h3>
            <button class="close-modal" id="close-modal">&times;</button>
        </div>
        
        <form id="event-form">
            <input type="hidden" id="event-date">
            <input type="hidden" id="event-id">
            
            <!-- Tipo de Evento (solo para Director) -->
            {% if rol_usuario == "Director" %}
            <div class="form-group">
                <label for="event-type">Tipo de Evento <span class="optional-label">(obligatorio)</span></label>
                <select id="event-type" class="form-control" required>
                    <option value="personal">Personal</option>
                    <option value="general">General (visible para todos)</option>
                </select>
            </div>
            {% endif %}
            
            <div class="form-group">
                <label for="event-title">Título <span class="optional-label">(obligatorio)</span></label>
                <input type="text" id="event-title" class="form-control" required>
            </div>
            
            <div class="form-group">
                <label for="event-description">Descripción <span class="optional-label">(opcional)</span></label>
                <textarea id="event-description" class="form-control" rows="3" placeholder="Detalles del evento..."></textarea>
            </div>
            
            <div class="form-group">
                <label for="event-location">Ubicación <span class="optional-label">(opcional)</span></label>
                <input type="text" id="event-location" class="form-control" placeholder="Ej: Sala de reuniones, Centro de salud...">
            </div>
            
            <!-- Todo el día -->
            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="event-all-day" style="width: auto;">
                    <span>Todo el día</span>
                </label>
            </div>
            
            <!-- Horarios (se ocultan si es todo el día) -->
            <div id="time-fields">
                <div class="form-group">
                    <label for="event-time-start">Hora de inicio <span class="optional-label">(obligatorio)</span></label>
                    <input type="time" id="event-time-start" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="event-time-end">Hora de fin <span class="optional-label">(obligatorio)</span></label>
                    <input type="time" id="event-time-end" class="form-control" required>
                </div>
            </div>
            
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" id="cancel-event">Cancelar</button>
                <button type="submit" class="btn btn-primary" id="save-event">Guardar</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal para ver detalles del día -->
<div class="modal-overlay" id="day-events-modal">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title" id="day-modal-title">Eventos del Día</h3>
            <button class="close-modal" id="close-day-modal">&times;</button>
        </div>
        
        <div class="modal-body" id="day-events-list">
            <!-- Los eventos del día se cargarán aquí -->
        </div>
        
        <div class="modal-actions">
            <button type="button" class="btn btn-secondary" id="close-day-events">Cerrar</button>
            <button type="button" class="btn btn-primary" id="add-event-to-day">
                <i class="fas fa-plus"></i> Agregar Evento
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
<script>
// Variables globales
let currentDate = new Date();
let events = [];
let userRol = "{{ rol_usuario|default:'Funcionario' }}";
let userId = {{ usuario.id_usuario|default:0 }};

// Elementos del DOM
const calendarDaysEl = document.getElementById('calendar-days');
const currentMonthEl = document.getElementById('current-month');
const prevMonthBtn = document.getElementById('prev-month');
const nextMonthBtn = document.getElementById('next-month');
const todayBtn = document.getElementById('today-btn');
const eventsListEl = document.getElementById('events-list');
const eventModal = document.getElementById('event-modal');
const dayEventsModal = document.getElementById('day-events-modal');
const closeModalBtn = document.getElementById('close-modal');
const closeDayModalBtn = document.getElementById('close-day-modal');
const cancelEventBtn = document.getElementById('cancel-event');
const closeDayEventsBtn = document.getElementById('close-day-events');
const addEventToDayBtn = document.getElementById('add-event-to-day');
const eventForm = document.getElementById('event-form');
const modalTitle = document.getElementById('modal-title');
const dayModalTitle = document.getElementById('day-modal-title');
const dayEventsListEl = document.getElementById('day-events-list');
const eventDateInput = document.getElementById('event-date');
const eventIdInput = document.getElementById('event-id');
const eventTitleInput = document.getElementById('event-title');
const eventDescriptionInput = document.getElementById('event-description');
const eventLocationInput = document.getElementById('event-location');
const eventAllDayInput = document.getElementById('event-all-day');
const eventTimeStartInput = document.getElementById('event-time-start');
const eventTimeEndInput = document.getElementById('event-time-end');
const timeFields = document.getElementById('time-fields');
const eventTypeInput = document.getElementById('event-type');

// Nombres de meses en español
const monthNames = [
    'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
    'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
];

// Inicializar la aplicación
async function init() {
    console.log('Inicializando calendario...');
    console.log('Rol del usuario:', userRol);
    console.log('ID del usuario:', userId);
    
    await loadEvents();
    setupEventListeners();
    renderCalendar();
    
    console.log('Calendario inicializado correctamente');
}

// Configurar event listeners
function setupEventListeners() {
    // Navegación del calendario
    prevMonthBtn.addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() - 1);
        renderCalendar();
    });
    
    nextMonthBtn.addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() + 1);
        renderCalendar();
    });
    
    todayBtn.addEventListener('click', () => {
        currentDate = new Date();
        renderCalendar();
    });
    
    // Cerrar modales
    closeModalBtn.addEventListener('click', () => closeModal(eventModal));
    closeDayModalBtn.addEventListener('click', () => closeModal(dayEventsModal));
    cancelEventBtn.addEventListener('click', () => closeModal(eventModal));
    closeDayEventsBtn.addEventListener('click', () => closeModal(dayEventsModal));
    
    // Agregar evento desde modal del día
    addEventToDayBtn.addEventListener('click', () => {
        const selectedDate = dayEventsModal.dataset.selectedDate;
        if (selectedDate) {
            closeModal(dayEventsModal);
            openEventModal(selectedDate);
        }
    });
    
    // Submit del formulario de evento
    eventForm.addEventListener('submit', saveEvent);
    
    // Toggle de campos de horario
    if (eventAllDayInput) {
        eventAllDayInput.addEventListener('change', function() {
            if (this.checked) {
                timeFields.style.display = 'none';
                eventTimeStartInput.removeAttribute('required');
                eventTimeEndInput.removeAttribute('required');
            } else {
                timeFields.style.display = 'block';
                eventTimeStartInput.setAttribute('required', 'required');
                eventTimeEndInput.setAttribute('required', 'required');
            }
        });
    }
    
    // Cerrar modales al hacer clic fuera
    eventModal.addEventListener('click', (e) => {
        if (e.target === eventModal) closeModal(eventModal);
    });
    
    dayEventsModal.addEventListener('click', (e) => {
        if (e.target === dayEventsModal) closeModal(dayEventsModal);
    });
}

// Cargar eventos desde la API
async function loadEvents() {
    try {
        const response = await fetch('/api/eventos/');
        const data = await response.json();
        events = data.results || [];
        console.log('Eventos cargados:', events.length);
        renderEventsList();
    } catch (error) {
        console.error('Error cargando eventos:', error);
        eventsListEl.innerHTML = `
            <div class="no-events">
                <i class="fas fa-exclamation-triangle"></i>
                <p>Error al cargar eventos</p>
            </div>
        `;
    }
}

// Renderizar calendario
function renderCalendar() {
    const currentMonth = currentDate.getMonth();
    const currentYear = currentDate.getFullYear();
    currentMonthEl.textContent = `${monthNames[currentMonth]} ${currentYear}`;
    
    const firstDay = new Date(currentYear, currentMonth, 1);
    const lastDay = new Date(currentYear, currentMonth + 1, 0);
    const daysInMonth = lastDay.getDate();
    
    let firstDayIndex = firstDay.getDay();
    if (firstDayIndex === 0) firstDayIndex = 6;
    else firstDayIndex -= 1;
    
    const prevMonthLastDay = new Date(currentYear, currentMonth, 0).getDate();
    
    calendarDaysEl.innerHTML = '';
    
    // Agregar días del mes anterior
    for (let i = firstDayIndex; i > 0; i--) {
        const day = document.createElement('div');
        day.className = 'day other-month';
        day.textContent = prevMonthLastDay - i + 1;
        calendarDaysEl.appendChild(day);
    }
    
    // Agregar días del mes actual
    const today = new Date();
    const isCurrentMonth = today.getMonth() === currentMonth && today.getFullYear() === currentYear;
    
    for (let i = 1; i <= daysInMonth; i++) {
        const day = document.createElement('div');
        day.className = 'day';
        
        if (isCurrentMonth && i === today.getDate()) {
            day.classList.add('today');
        }
        
        const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
        day.dataset.date = dateStr;
        
        const dayNumber = document.createElement('div');
        dayNumber.className = 'day-number';
        dayNumber.textContent = i;
        day.appendChild(dayNumber);
        
        const dayEventsContainer = document.createElement('div');
        dayEventsContainer.className = 'day-events';
        
        const dayEvents = events.filter(event => event.fecha === dateStr);
        
        // Mostrar eventos existentes
        if (dayEvents.length > 0) {
            day.classList.add('has-events');
            
            // Mostrar máximo 2 eventos en la celda
            const eventsToShow = dayEvents.slice(0, 2);
            eventsToShow.forEach(event => {
                const eventEl = document.createElement('div');
                eventEl.className = `day-event ${event.es_general ? 'general-event' : 'personal-event'}`;
                eventEl.style.backgroundColor = event.color || (event.es_general ? '#FF6B6B' : '#3A8DFF');
                eventEl.textContent = event.titulo.substring(0, 12) + (event.titulo.length > 12 ? '...' : '');
                eventEl.title = event.titulo;
                dayEventsContainer.appendChild(eventEl);
            });
            
            // Si hay más de 2 eventos, mostrar indicador
            if (dayEvents.length > 2) {
                const moreIndicator = document.createElement('div');
                moreIndicator.className = 'day-event';
                moreIndicator.textContent = `+${dayEvents.length - 2} más`;
                moreIndicator.style.fontSize = '0.7rem';
                moreIndicator.style.opacity = '0.7';
                moreIndicator.style.backgroundColor = '#666';
                moreIndicator.title = `Ver los ${dayEvents.length} eventos de este día`;
                dayEventsContainer.appendChild(moreIndicator);
            }
        }
        
        day.appendChild(dayEventsContainer);
        
        // Agregar botón + si el usuario puede agregar eventos
        const addButton = document.createElement('button');
        addButton.className = 'add-event-btn';
        addButton.innerHTML = '<i class="fas fa-plus"></i>';
        addButton.title = 'Agregar nuevo evento';
        day.appendChild(addButton);
        
        addButton.addEventListener('click', (e) => {
            e.stopPropagation();
            openEventModal(dateStr);
        });
        
        // Al hacer clic en el día, mostrar eventos
        day.addEventListener('click', () => {
            showDayEvents(dateStr, dayEvents);
        });
        
        calendarDaysEl.appendChild(day);
    }
    
    // Agregar días del próximo mes
    const totalCells = 42;
    const daysSoFar = firstDayIndex + daysInMonth;
    const nextMonthDays = totalCells - daysSoFar;
    
    for (let i = 1; i <= nextMonthDays; i++) {
        const day = document.createElement('div');
        day.className = 'day other-month';
        day.textContent = i;
        calendarDaysEl.appendChild(day);
    }
}

// Mostrar eventos del día
function showDayEvents(dateStr, dayEvents) {
    const [year, month, day] = dateStr.split('-');
    const formattedDate = `${day}/${month}/${year}`;
    
    dayModalTitle.textContent = `Eventos del día ${formattedDate}`;
    dayEventsModal.dataset.selectedDate = dateStr;
    
    if (dayEvents.length === 0) {
        dayEventsListEl.innerHTML = `
            <div class="no-events">
                <i class="fas fa-calendar-times"></i>
                <p>No hay eventos para este día</p>
            </div>
        `;
    } else {
        dayEventsListEl.innerHTML = dayEvents.map(event => {
            let timeDisplay = '';
            if (event.todo_el_dia) {
                timeDisplay = 'Todo el día';
            } else if (event.hora_inicio) {
                timeDisplay = event.hora_inicio.substring(0, 5);
                if (event.hora_fin) {
                    timeDisplay += ` - ${event.hora_fin.substring(0, 5)}`;
                }
            }
            
            return `
            <div class="event-item ${event.es_general ? 'general' : 'personal'}">
                <div class="event-header">
                    <div class="event-title">${event.titulo}</div>
                    <span class="event-type ${event.es_general ? 'general' : 'personal'}">
                        ${event.es_general ? 'General' : 'Personal'}
                    </span>
                </div>
                <div class="event-date">
                    <i class="far fa-clock"></i>
                    ${timeDisplay}
                </div>
                ${event.ubicacion ? `
                    <div class="event-date">
                        <i class="fas fa-map-marker-alt"></i>
                        ${event.ubicacion}
                    </div>
                ` : ''}
                ${event.descripcion ? `<div class="event-description">${event.descripcion}</div>` : ''}
                <div class="event-author">
                    <div class="author-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <span>${event.usuario_nombre || 'Sin asignar'}</span>
                </div>
                ${event.editable || userRol === 'Director' || userRol === 'Admin' ? `
                    <div style="margin-top: 10px; display: flex; gap: 10px;">
                        <button onclick="editEvent(${event.id})" style="
                            background: #0B2C4A; 
                            color: white; 
                            border: none; 
                            padding: 5px 10px; 
                            border-radius: 3px; 
                            cursor: pointer;
                            font-size: 0.8rem;
                        ">
                            <i class="far fa-edit"></i> Editar
                        </button>
                        <button onclick="deleteEvent(${event.id})" style="
                            background: #dc3545; 
                            color: white; 
                            border: none; 
                            padding: 5px 10px; 
                            border-radius: 3px; 
                            cursor: pointer;
                            font-size: 0.8rem;
                        ">
                            <i class="far fa-trash-alt"></i> Eliminar
                        </button>
                    </div>
                ` : ''}
            </div>
        `}).join('');
    }
    
    openModal(dayEventsModal);
}

// Renderizar lista de todos los eventos
function renderEventsList() {
    if (events.length === 0) {
        eventsListEl.innerHTML = `
            <div class="no-events">
                <i class="fas fa-calendar-times"></i>
                <p>No hay eventos programados</p>
            </div>
        `;
        return;
    }
    
    // Ordenar eventos por fecha (más reciente primero)
    const sortedEvents = [...events].sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
    
    eventsListEl.innerHTML = sortedEvents.map(event => {
        const [year, month, day] = event.fecha.split('-');
        const formattedDate = `${day}/${month}/${year}`;
        
        let timeDisplay = '';
        if (event.todo_el_dia) {
            timeDisplay = '<i class="far fa-clock"></i> Todo el día';
        } else if (event.hora_inicio) {
            timeDisplay = `<i class="far fa-clock"></i> ${event.hora_inicio.substring(0, 5)}`;
            if (event.hora_fin) {
                timeDisplay += ` - ${event.hora_fin.substring(0, 5)}`;
            }
        }
        
        return `
            <div class="event-item ${event.es_general ? 'general' : 'personal'}" onclick="showEventDetail(${event.id})">
                <div class="event-header">
                    <div class="event-title">${event.titulo}</div>
                    <span class="event-type ${event.es_general ? 'general' : 'personal'}">
                        ${event.es_general ? 'General' : 'Personal'}
                    </span>
                </div>
                <div class="event-date">
                    <i class="far fa-calendar"></i> ${formattedDate}
                    ${timeDisplay ? ` • ${timeDisplay}` : ''}
                </div>
                ${event.ubicacion ? `
                    <div class="event-date">
                        <i class="fas fa-map-marker-alt"></i> ${event.ubicacion}
                    </div>
                ` : ''}
                ${event.descripcion ? `
                    <div class="event-description">
                        ${event.descripcion.substring(0, 80)}${event.descripcion.length > 80 ? '...' : ''}
                    </div>
                ` : ''}
                <div class="event-author">
                    <div class="author-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <span>${event.usuario_nombre || 'Sin asignar'}</span>
                </div>
            </div>
        `;
    }).join('');
}

// Abrir modal para agregar/editar evento
function openEventModal(dateStr, eventId = null) {
    eventForm.reset();
    eventIdInput.value = '';
    
    const [year, month, day] = dateStr.split('-');
    const formattedDate = `${day}/${month}/${year}`;
    
    eventDateInput.value = dateStr;
    modalTitle.textContent = eventId ? 'Editar Evento' : `Agregar Evento - ${formattedDate}`;
    
    // Mostrar campos de horario por defecto
    timeFields.style.display = 'block';
    eventTimeStartInput.setAttribute('required', 'required');
    eventTimeEndInput.setAttribute('required', 'required');
    
    if (eventId) {
        const event = events.find(e => e.id === eventId);
        if (event) {
            eventIdInput.value = event.id;
            eventTitleInput.value = event.titulo;
            eventDescriptionInput.value = event.descripcion || '';
            eventLocationInput.value = event.ubicacion || '';
            
            if (eventTypeInput) {
                eventTypeInput.value = event.es_general ? 'general' : 'personal';
            }
            
            if (event.todo_el_dia) {
                eventAllDayInput.checked = true;
                timeFields.style.display = 'none';
                eventTimeStartInput.removeAttribute('required');
                eventTimeEndInput.removeAttribute('required');
            } else {
                eventAllDayInput.checked = false;
                eventTimeStartInput.value = event.hora_inicio ? event.hora_inicio.substring(0, 5) : '';
                eventTimeEndInput.value = event.hora_fin ? event.hora_fin.substring(0, 5) : '';
            }
        }
    }
    
    openModal(eventModal);
}

// Abrir modal
function openModal(modal) {
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
}

// Cerrar modal
function closeModal(modal) {
    modal.classList.remove('active');
    document.body.style.overflow = '';
}

// Guardar evento
async function saveEvent(e) {
    e.preventDefault();
    
    const eventId = eventIdInput.value;
    const date = eventDateInput.value;
    const title = eventTitleInput.value.trim();
    const description = eventDescriptionInput.value.trim();
    const location = eventLocationInput.value.trim();
    const allDay = eventAllDayInput.checked;
    const timeStart = eventTimeStartInput.value;
    const timeEnd = eventTimeEndInput.value;
    
    if (!title) {
        alert('Por favor, ingresa un título para el evento.');
        return;
    }
    
    // Validar horarios si no es todo el día
    if (!allDay) {
        if (!timeStart || !timeEnd) {
            alert('Por favor, ingresa las horas de inicio y fin.');
            return;
        }
        
        if (timeStart >= timeEnd) {
            alert('La hora de fin debe ser posterior a la hora de inicio.');
            return;
        }
    }
    
    // Preparar datos para la API
    const eventData = {
        titulo: title,
        fecha: date,
        descripcion: description,
        ubicacion: location,
        todo_el_dia: allDay
    };
    
    // Agregar horarios si no es todo el día
    if (!allDay) {
        eventData.hora_inicio = timeStart + ':00';
        eventData.hora_fin = timeEnd + ':00';
    }
    
    // Solo Director puede seleccionar tipo de evento
    if (eventTypeInput) {
        eventData.es_general = (eventTypeInput.value === 'general');
    }
    
    try {
        let url = '/api/eventos/';
        let method = 'POST';
        
        if (eventId) {
            url = `/api/eventos/${eventId}/`;
            method = 'PUT';
        }
        
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
            },
            body: JSON.stringify(eventData)
        });
        
        if (response.ok) {
            await loadEvents();
            closeModal(eventModal);
            renderCalendar();
            alert(eventId ? 'Evento actualizado exitosamente.' : 'Evento creado exitosamente.');
        } else {
            const error = await response.text();
            alert(`Error: ${error}`);
        }
    } catch (error) {
        console.error('Error guardando evento:', error);
        alert('Error al guardar el evento.');
    }
}

// Editar evento
function editEvent(eventId) {
    const event = events.find(e => e.id === eventId);
    if (event) {
        closeModal(dayEventsModal);
        openEventModal(event.fecha, eventId);
    }
}

// Eliminar evento
async function deleteEvent(eventId) {
    const event = events.find(e => e.id === eventId);
    if (!event) return;
    
    if (confirm('¿Estás seguro de que quieres eliminar este evento?')) {
        try {
            const response = await fetch(`/api/eventos/${eventId}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                }
            });
            
            if (response.ok) {
                await loadEvents();
                closeModal(dayEventsModal);
                renderCalendar();
                alert('Evento eliminado exitosamente.');
            } else {
                alert('Error al eliminar el evento.');
            }
        } catch (error) {
            console.error('Error eliminando evento:', error);
            alert('Error al eliminar el evento.');
        }
    }
}

// Mostrar detalle de evento
function showEventDetail(eventId) {
    const event = events.find(e => e.id === eventId);
    if (!event) return;
    
    const [year, month, day] = event.fecha.split('-');
    const formattedDate = `${day}/${month}/${year}`;
    
    let timeDisplay = '';
    if (event.todo_el_dia) {
        timeDisplay = 'Todo el día';
    } else if (event.hora_inicio) {
        timeDisplay = event.hora_inicio.substring(0, 5);
        if (event.hora_fin) {
            timeDisplay += ` - ${event.hora_fin.substring(0, 5)}`;
        }
    }
    
    const modalHtml = `
        <div class="modal-overlay active" id="event-detail-modal">
            <div class="modal" style="max-width: 500px;">
                <div class="modal-header">
                    <h3 class="modal-title">Detalle del Evento</h3>
                    <button class="close-modal" onclick="closeEventDetailModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div style="margin-bottom: 15px;">
                        <strong style="font-size: 1.2rem;">${event.titulo}</strong>
                        <span class="event-type ${event.es_general ? 'general' : 'personal'}" style="margin-left: 10px;">
                            ${event.es_general ? 'Evento General' : 'Evento Personal'}
                        </span>
                    </div>
                    
                    <div style="background-color: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                        <div style="display: flex; align-items: center; margin-bottom: 10px;">
                            <i class="far fa-calendar" style="width: 20px; color: #666;"></i>
                            <span style="margin-left: 10px;">${formattedDate}</span>
                        </div>
                        
                        <div style="display: flex; align-items: center; margin-bottom: 10px;">
                            <i class="far fa-clock" style="width: 20px; color: #666;"></i>
                            <span style="margin-left: 10px;">${timeDisplay}</span>
                        </div>
                        
                        ${event.ubicacion ? `
                            <div style="display: flex; align-items: center; margin-bottom: 10px;">
                                <i class="fas fa-map-marker-alt" style="width: 20px; color: #666;"></i>
                                <span style="margin-left: 10px;">${event.ubicacion}</span>
                            </div>
                        ` : ''}
                        
                        <div style="display: flex; align-items: center; margin-bottom: 10px;">
                            <i class="far fa-user" style="width: 20px; color: #666;"></i>
                            <span style="margin-left: 10px;">${event.usuario_nombre || 'Sin asignar'}</span>
                        </div>
                        
                        ${event.descripcion ? `
                            <div style="margin-top: 15px;">
                                <strong>Descripción:</strong>
                                <p style="margin-top: 5px; white-space: pre-wrap;">${event.descripcion}</p>
                            </div>
                        ` : ''}
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeEventDetailModal()">Cerrar</button>
                    ${event.editable || userRol === 'Director' || userRol === 'Admin' ? `
                        <button type="button" class="btn btn-primary" onclick="editEvent(${event.id}); closeEventDetailModal()">
                            <i class="far fa-edit"></i> Editar
                        </button>
                        <button type="button" class="btn" style="background-color: #dc3545; color: white;" onclick="deleteEvent(${event.id}); closeEventDetailModal()">
                            <i class="far fa-trash-alt"></i> Eliminar
                        </button>
                    ` : ''}
                </div>
            </div>
        </div>
    `;
    
    const modalContainer = document.createElement('div');
    modalContainer.innerHTML = modalHtml;
    document.body.appendChild(modalContainer.firstElementChild);
    document.body.style.overflow = 'hidden';
}

function closeEventDetailModal() {
    const modal = document.getElementById('event-detail-modal');
    if (modal) {
        modal.remove();
        document.body.style.overflow = '';
    }
}

// Función para obtener cookie CSRF
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Inicializar la aplicación cuando se carga la página
document.addEventListener('DOMContentLoaded', init);
</script>
{% endblock %}