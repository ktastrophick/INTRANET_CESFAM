
{% extends "base/base.html" %}
{% load static %}

{% block title %}Calendario General ‚Äî Intranet CESFAM{% endblock %}

{% block extra_css %} 
    <link rel="stylesheet" href="{% static 'css/calendario.css' %}">
    <style>
        :root {
            --primary-color: #0B2C4A;
            --secondary-color: #8338ec;
            --vacation-color: #38b000;
            --admin-color: #ff006e;
            --warning-color: #ff9e00;
            --background-color: #f8f9fa;
            --card-color: #ffffff;
            --text-color: #333333;
            --border-color: #e0e0e0;
            --sidebar-width: 300px;
        }
        
        .calendar-general-container {
            background-color: var(--background-color);
            min-height: calc(100vh - 60px);
            padding: 20px;
        }
        
        .page-header {
            margin-bottom: 30px;
        }
        
        .page-title {
            font-size: 2rem;
            color: var(--primary-color);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .page-description {
            color: #666;
            font-size: 1.1rem;
            max-width: 800px;
            margin-bottom: 20px;
        }
        
        /* Dashboard de dos columnas */
        .dashboard-container {
            display: grid;
            grid-template-columns: 1fr 1.5fr;
            gap: 30px;
        }
        
        @media (max-width: 1100px) {
            .dashboard-container {
                grid-template-columns: 1fr;
            }
        }
        
        /* Columna izquierda - Resumen y Comunicados */
        .left-column {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }
        
        /* Resumen de D√≠as */
        .days-summary {
            background-color: var(--card-color);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .summary-title {
            font-size: 1.3rem;
            margin-bottom: 20px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .summary-title i {
            font-size: 1.5rem;
        }
        
        .days-total {
            background-color: #f0f7ff;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            margin-bottom: 25px;
        }
        
        .days-available {
            font-size: 2.8rem;
            font-weight: bold;
            color: var(--primary-color);
            line-height: 1;
            margin-bottom: 5px;
        }
        
        .days-label {
            font-size: 1rem;
            color: #666;
        }
        
        .days-breakdown {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .days-type {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-radius: 10px;
            transition: transform 0.2s;
        }
        
        .days-type:hover {
            transform: translateY(-3px);
        }
        
        .vacation-days {
            background-color: rgba(56, 176, 0, 0.1);
            border-left: 5px solid var(--vacation-color);
        }
        
        .admin-days {
            background-color: rgba(255, 0, 110, 0.1);
            border-left: 5px solid var(--admin-color);
        }
        
        .type-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .type-icon {
            font-size: 1.5rem;
        }
        
        .vacation-days .type-icon {
            color: var(--vacation-color);
        }
        
        .admin-days .type-icon {
            color: var(--admin-color);
        }
        
        .type-name {
            font-weight: 600;
            font-size: 1rem;
        }
        
        .type-available {
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .vacation-days .type-available {
            color: var(--vacation-color);
        }
        
        .admin-days .type-available {
            color: var(--admin-color);
        }
        
        /* Bot√≥n crear comunicado */
        .create-announcement-btn {
            background: linear-gradient(135deg, var(--primary-color), #2a75f0);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 15px;
            font-weight: 600;
            width: 100%;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 1rem;
            margin-top: 10px;
        }
        
        .create-announcement-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(58, 134, 255, 0.3);
        }
        
        /* Secci√≥n de Comunicados */
        .announcements-section {
            background-color: var(--card-color);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .announcements-title {
            font-size: 1.3rem;
            margin-bottom: 20px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .announcements-title i {
            font-size: 1.5rem;
        }
        
        .announcements-list {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 10px;
        }
        
        .announcement-item {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid var(--primary-color);
            background-color: #f9f9f9;
            transition: all 0.2s;
        }
        
        .announcement-item:hover {
            background-color: #f0f7ff;
        }
        
        .announcement-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        
        .announcement-title {
            font-weight: 600;
            font-size: 1rem;
            color: var(--text-color);
        }
        
        .announcement-date {
            font-size: 0.8rem;
            color: #666;
            white-space: nowrap;
        }
        
        .announcement-content {
            font-size: 0.9rem;
            color: #555;
            margin-bottom: 10px;
        }
        
        .announcement-author {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8rem;
            color: #777;
        }
        
        .author-avatar {
            width: 25px;
            height: 25px;
            background: linear-gradient(135deg, var(--secondary-color), #6a28cc);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.8rem;
        }
        
        .no-announcements {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }
        
        .no-announcements i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #ddd;
        }
        
        /* Columna derecha - Calendario */
        .calendar-section {
            background-color: var(--card-color);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .calendar-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .calendar-title i {
            font-size: 1.8rem;
        }
        
        .calendar-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .current-month {
            font-size: 1.4rem;
            font-weight: 600;
            color: var(--text-color);
        }
        
        .calendar-nav {
            display: flex;
            gap: 10px;
        }
        
        .nav-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .nav-btn:hover {
            background-color: #2a75f0;
        }
        
        .calendar-weekdays, .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }
        
        .calendar-weekdays div {
            text-align: center;
            font-weight: 600;
            padding: 10px 0;
            color: #666;
        }
        
        .calendar-days {
            margin-top: 10px;
        }
        
        .day {
            height: 100px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }
        
        .day:hover {
            background-color: #f0f7ff;
            transform: scale(1.02);
        }
        
        .day-number {
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 1.1rem;
        }
        
        .day-events {
            flex: 1;
            overflow-y: auto;
            padding-right: 2px;
        }
        
        .day-event {
            font-size: 0.75rem;
            padding: 3px 6px;
            border-radius: 4px;
            margin-bottom: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .vacation-event {
            background-color: rgba(56, 176, 0, 0.2);
            color: var(--vacation-color);
            border-left: 3px solid var(--vacation-color);
        }
        
        .admin-event {
            background-color: rgba(255, 0, 110, 0.2);
            color: var(--admin-color);
            border-left: 3px solid var(--admin-color);
        }
        
        .announcement-event {
            background-color: rgba(255, 158, 0, 0.2);
            color: var(--warning-color);
            border-left: 3px solid var(--warning-color);
        }
        
        .other-month {
            color: #ccc;
            background-color: #f9f9f9;
        }
        
        .today {
            background-color: rgba(58, 134, 255, 0.1);
            border: 2px solid var(--primary-color);
        }
        
        .day.has-events::after {
            content: '';
            position: absolute;
            top: 5px;
            right: 5px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--primary-color);
        }
        
        /* Modal para eventos */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }
        
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal {
            background-color: white;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            transform: translateY(-20px);
            transition: transform 0.3s;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-overlay.active .modal {
            transform: translateY(0);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 1.5rem;
            color: var(--primary-color);
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #999;
            transition: color 0.2s;
        }
        
        .close-modal:hover {
            color: var(--text-color);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }
        
        .optional-label {
            color: #999;
            font-weight: normal;
        }
        
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 30px;
        }
        
        .btn {
            padding: 12px 25px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2a75f0;
        }
        
        .btn-secondary {
            background-color: #f0f0f0;
            color: var(--text-color);
        }
        
        .btn-secondary:hover {
            background-color: #e0e0e0;
        }
        
        /* Leyenda del calendario */
        .calendar-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }
        
        .legend-color {
            width: 15px;
            height: 15px;
            border-radius: 3px;
        }
        
        .legend-vacation {
            background-color: var(--vacation-color);
        }
        
        .legend-admin {
            background-color: var(--admin-color);
        }
        
        .legend-announcement {
            background-color: var(--warning-color);
        }
        
        /* Instrucciones */
        .instructions {
            margin-top: 20px;
            color: #666;
            font-size: 0.9rem;
        }
        
        .instructions i {
            margin-right: 5px;
            color: var(--primary-color);
        }
        
        /* Scrollbar personalizado */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        /* Bot√≥n de reinicio */
        .delete-btn {
            background-color: #ffebee;
            color: #d32f2f;
            border: 1px solid #ffcdd2;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .delete-btn:hover {
            background-color: #ffcdd2;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .calendar-general-container {
                padding: 15px;
            }
            
            .page-title {
                font-size: 1.5rem;
            }
            
            .day {
                height: 80px;
            }
        }
        
        @media (max-width: 480px) {
            .days-summary, .announcements-section, .calendar-section {
                padding: 20px;
            }
            
            .calendar-controls {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            
            .calendar-nav {
                align-self: flex-end;
            }
        }
    </style>
{% endblock %}

{% block content %}
<div class="calendar-general-container">
    <div class="page-header">
        <h1 class="page-title">
            <i class="fas fa-calendar-alt"></i> Calendario 
        </h1>
                <div class="text-muted small">
                    <i class="bi bi-info-circle"></i> Ingrese los eventos en el calendario
                </div>
        <br>
        <!-- Columna derecha: Calendario General -->
        <section class="calendar-section">
            <div class="calendar-title">
                <span><i class="far fa-calendar"></i> Calendario General</span>
            </div>
            
            <div class="calendar-controls">
                <div class="current-month" id="current-month"></div>
                <div class="calendar-nav">
                    <button class="nav-btn" id="prev-month">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button class="nav-btn" id="today-btn">
                        Hoy
                    </button>
                    <button class="nav-btn" id="next-month">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
            
            <div class="calendar-weekdays">
                <div>Lun</div>
                <div>Mar</div>
                <div>Mi√©</div>
                <div>Jue</div>
                <div>Vie</div>
                <div>S√°b</div>
                <div>Dom</div>
            </div>
            
            <div class="calendar-days" id="calendar-days">
                <!-- Los d√≠as del calendario se generar√°n con JavaScript -->
            </div>
            
            <!-- Leyenda del calendario -->
            <div class="calendar-legend">
                <div class="legend-item">
                    <div class="legend-color legend-vacation"></div>
                    <span>Vacaciones</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color legend-admin"></div>
                    <span>Administrativos</span>
                </div>
            </div>
            <div class="dashboard-card">
                <h3 class="card-title">Todos los Eventos</h3>
                <div class="activities-list" id="upcoming-activities">
                    <!-- Los eventos se deben filtrar desde el mas reciente al mas antiguo -->
                </div>
            </div>
        </section>
    </div>
</div>

<!-- Modal para agregar/editar eventos -->
<div class="modal-overlay" id="event-modal">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title" id="modal-title">Agregar Evento</h3>
            <button class="close-modal" id="close-modal">&times;</button>
        </div>
        
        <form id="event-form">
            <input type="hidden" id="event-date">
            <input type="hidden" id="event-id">
            <input type="hidden" id="event-category" value="event">
            
            <div class="form-group">
                <label for="event-title">T√≠tulo <span class="optional-label">(obligatorio)</span></label>
                <input type="text" id="event-title" class="form-control" required>
            </div>
            
            <div class="form-group">
                <label for="event-type">Tipo</label>
                <select id="event-type" class="form-control">
                    <option value="vacation">Vacaciones</option>
                    <option value="admin">D√≠a Administrativo</option>
                    <option value="other">Otro evento</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="event-time">Hora <span class="optional-label">(opcional)</span></label>
                <input type="time" id="event-time" class="form-control">
            </div>
            
            <div class="form-group">
                <label for="event-location">Ubicaci√≥n <span class="optional-label">(opcional)</span></label>
                <input type="text" id="event-location" class="form-control" placeholder="Ej: Oficina de Direcci√≥n, Auditorio, etc.">
            </div>
            
            <div class="form-group" id="description-group">
                <label for="event-description">Descripci√≥n <span class="optional-label">(opcional)</span></label>
                <textarea id="event-description" class="form-control" rows="4" placeholder="Detalles del evento o comunicado..."></textarea>
            </div>
            
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" id="cancel-event">Cancelar</button>
                <button type="submit" class="btn btn-primary" id="save-event">Guardar</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal para crear comunicado -->
<div class="modal-overlay" id="announcement-modal">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">Crear Comunicado</h3>
            <button class="close-modal" id="close-announcement-modal">&times;</button>
        </div>
        
        <form id="announcement-form">
            <div class="form-group">
                <label for="announcement-title">T√≠tulo del comunicado <span class="optional-label">(obligatorio)</span></label>
                <input type="text" id="announcement-title" class="form-control" required>
            </div>
            
            <div class="form-group">
                <label for="announcement-content">Contenido <span class="optional-label">(obligatorio)</span></label>
                <textarea id="announcement-content" class="form-control" rows="6" required placeholder="Escribe aqu√≠ el contenido del comunicado..."></textarea>
            </div>
            
            <div class="form-group">
                <label for="announcement-date">Fecha del comunicado</label>
                <input type="date" id="announcement-date" class="form-control" value="">
            </div>
            
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" id="cancel-announcement">Cancelar</button>
                <button type="submit" class="btn btn-primary" id="save-announcement">Publicar Comunicado</button>
            </div>
        </form>

    </div>
</div>
{% endblock %}

{% block extra_js %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script src=""></script>
    <script>
        // Variables globales
let currentDate = new Date();
let events = JSON.parse(localStorage.getItem('calendarEvents')) || [];
let announcements = JSON.parse(localStorage.getItem('calendarAnnouncements')) || [];
let vacationDays = 10;
let adminDays = 5;

// Elementos del DOM
const calendarDaysEl = document.getElementById('calendar-days');
const currentMonthEl = document.getElementById('current-month');
const prevMonthBtn = document.getElementById('prev-month');
const nextMonthBtn = document.getElementById('next-month');
const todayBtn = document.getElementById('today-btn');
const eventModal = document.getElementById('event-modal');
const announcementModal = document.getElementById('announcement-modal');
const closeModalBtn = document.getElementById('close-modal');
const closeAnnouncementModalBtn = document.getElementById('close-announcement-modal');
const cancelEventBtn = document.getElementById('cancel-event');
const cancelAnnouncementBtn = document.getElementById('cancel-announcement');
const eventForm = document.getElementById('event-form');
const announcementForm = document.getElementById('announcement-form');
const modalTitle = document.getElementById('modal-title');
const eventDateInput = document.getElementById('event-date');
const eventIdInput = document.getElementById('event-id');
const eventCategoryInput = document.getElementById('event-category');
const eventTitleInput = document.getElementById('event-title');
const eventTypeInput = document.getElementById('event-type');
const eventTimeInput = document.getElementById('event-time');
const eventLocationInput = document.getElementById('event-location');
const eventDescriptionInput = document.getElementById('event-description');
const announcementTitleInput = document.getElementById('announcement-title');
const announcementContentInput = document.getElementById('announcement-content');
const announcementDateInput = document.getElementById('announcement-date');

// Elementos opcionales (que pueden no existir)
const resetEventsBtn = document.getElementById('reset-events');
const vacationDaysEl = document.getElementById('vacation-days');
const adminDaysEl = document.getElementById('admin-days');
const totalDaysEl = document.getElementById('total-days');
const announcementsListEl = document.getElementById('announcements-list');
const announcementsCountEl = document.getElementById('announcements-count');
const createAnnouncementBtn = document.getElementById('createAnnouncementBtn');

// Nombres de meses en espa√±ol
const monthNames = [
    'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
    'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
];

// Inicializar la aplicaci√≥n
function init() {
    console.log('Inicializando calendario...');
    
    // Configurar fecha por defecto para comunicados (hoy)
    if (announcementDateInput) {
        announcementDateInput.valueAsDate = new Date();
    }
    
    renderCalendar();
    updateDayCounts();
    loadAnnouncements();
    setupEventListeners();
    
    console.log('Calendario inicializado correctamente');
}

// Configurar event listeners
function setupEventListeners() {
    console.log('Configurando event listeners...');
    
    // Navegaci√≥n del calendario
    if (prevMonthBtn) {
        prevMonthBtn.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        });
    }
    
    if (nextMonthBtn) {
        nextMonthBtn.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        });
    }
    
    if (todayBtn) {
        todayBtn.addEventListener('click', () => {
            currentDate = new Date();
            renderCalendar();
        });
    }
    
    // Event listeners para cerrar modales
    if (closeModalBtn) {
        closeModalBtn.addEventListener('click', (e) => {
            e.preventDefault();
            console.log('Click en bot√≥n X del modal de eventos');
            closeModal(eventModal);
        });
    } else {
        console.error('ERROR: close-modal button no encontrado');
    }
    
    if (closeAnnouncementModalBtn) {
        closeAnnouncementModalBtn.addEventListener('click', (e) => {
            e.preventDefault();
            console.log('Click en bot√≥n X del modal de comunicados');
            closeModal(announcementModal);
        });
    } else {
        console.error('ERROR: close-announcement-modal button no encontrado');
    }
    
    if (cancelEventBtn) {
        cancelEventBtn.addEventListener('click', (e) => {
            e.preventDefault();
            console.log('Click en bot√≥n Cancelar del modal de eventos');
            closeModal(eventModal);
        });
    } else {
        console.error('ERROR: cancel-event button no encontrado');
    }
    
    if (cancelAnnouncementBtn) {
        cancelAnnouncementBtn.addEventListener('click', (e) => {
            e.preventDefault();
            console.log('Click en bot√≥n Cancelar del modal de comunicados');
            closeModal(announcementModal);
        });
    } else {
        console.error('ERROR: cancel-announcement button no encontrado');
    }
    
    // Submit de formularios
    if (eventForm) {
        eventForm.addEventListener('submit', saveEvent);
    }
    
    if (announcementForm) {
        announcementForm.addEventListener('submit', saveAnnouncement);
    }
    
    // Bot√≥n de reiniciar (opcional)
    if (resetEventsBtn) {
        resetEventsBtn.addEventListener('click', resetEvents);
    }
    
    // Bot√≥n crear comunicado (opcional)
    if (createAnnouncementBtn) {
        createAnnouncementBtn.addEventListener('click', openAnnouncementModal);
    }
    
    // Cerrar modal al hacer clic fuera
    if (eventModal) {
        eventModal.addEventListener('click', (e) => {
            if (e.target === eventModal) {
                closeModal(eventModal);
            }
        });
    }
    
    if (announcementModal) {
        announcementModal.addEventListener('click', (e) => {
            if (e.target === announcementModal) {
                closeModal(announcementModal);
            }
        });
    }
    
    // Cambiar el formulario seg√∫n el tipo de evento seleccionado
    if (eventTypeInput) {
        eventTypeInput.addEventListener('change', updateFormByEventType);
    }
    
    console.log('Event listeners configurados correctamente');
}

// Renderizar calendario
function renderCalendar() {
    const currentMonth = currentDate.getMonth();
    const currentYear = currentDate.getFullYear();
    currentMonthEl.textContent = `${monthNames[currentMonth]} ${currentYear}`;
    
    const firstDay = new Date(currentYear, currentMonth, 1);
    const lastDay = new Date(currentYear, currentMonth + 1, 0);
    const daysInMonth = lastDay.getDate();
    
    let firstDayIndex = firstDay.getDay();
    if (firstDayIndex === 0) firstDayIndex = 6;
    else firstDayIndex -= 1;
    
    const prevMonthLastDay = new Date(currentYear, currentMonth, 0).getDate();
    
    calendarDaysEl.innerHTML = '';
    
    // Agregar d√≠as del mes anterior
    for (let i = firstDayIndex; i > 0; i--) {
        const day = document.createElement('div');
        day.className = 'day other-month';
        day.textContent = prevMonthLastDay - i + 1;
        calendarDaysEl.appendChild(day);
    }
    
    // Agregar d√≠as del mes actual
    const today = new Date();
    const isCurrentMonth = today.getMonth() === currentMonth && today.getFullYear() === currentYear;
    
    for (let i = 1; i <= daysInMonth; i++) {
        const day = document.createElement('div');
        day.className = 'day';
        
        if (isCurrentMonth && i === today.getDate()) {
            day.classList.add('today');
        }
        
        const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
        day.dataset.date = dateStr;
        
        const dayNumber = document.createElement('div');
        dayNumber.className = 'day-number';
        dayNumber.textContent = i;
        day.appendChild(dayNumber);
        
        const dayEventsContainer = document.createElement('div');
        dayEventsContainer.className = 'day-events';
        
        const dayEvents = events.filter(event => event.date === dateStr);
        dayEvents.forEach(event => {
            const eventEl = document.createElement('div');
            eventEl.className = `day-event ${event.type}-event`;
            eventEl.textContent = event.title;
            eventEl.title = event.title + (event.location ? ` (${event.location})` : '');
            dayEventsContainer.appendChild(eventEl);
        });
        
        const dayAnnouncements = announcements.filter(announcement => announcement.date === dateStr);
        dayAnnouncements.forEach(announcement => {
            const announcementEl = document.createElement('div');
            announcementEl.className = 'day-event announcement-event';
            announcementEl.textContent = ` ${announcement.title}`;
            announcementEl.title = announcement.title;
            dayEventsContainer.appendChild(announcementEl);
        });
        
        if (dayEvents.length > 0 || dayAnnouncements.length > 0) {
            day.classList.add('has-events');
        }
        
        day.appendChild(dayEventsContainer);
        day.addEventListener('click', () => openEventModal(dateStr));
        
        calendarDaysEl.appendChild(day);
    }
    
    // Agregar d√≠as del pr√≥ximo mes
    const totalCells = 42;
    const daysSoFar = firstDayIndex + daysInMonth;
    const nextMonthDays = totalCells - daysSoFar;
    
    for (let i = 1; i <= nextMonthDays; i++) {
        const day = document.createElement('div');
        day.className = 'day other-month';
        day.textContent = i;
        calendarDaysEl.appendChild(day);
    }
}

// Abrir modal para agregar/editar evento
function openEventModal(dateStr, eventId = null) {
    console.log('Abriendo modal para fecha:', dateStr);
    
    eventForm.reset();
    eventIdInput.value = '';
    if (eventCategoryInput) {
        eventCategoryInput.value = 'event';
    }
    
    const [year, month, day] = dateStr.split('-');
    const formattedDate = `${day}/${month}/${year}`;
    
    eventDateInput.value = dateStr;
    modalTitle.textContent = eventId ? 'Editar Evento' : `Agregar Evento - ${formattedDate}`;
    
    if (eventId) {
        const event = events.find(e => e.id === eventId);
        if (event) {
            eventIdInput.value = event.id;
            eventTitleInput.value = event.title;
            eventTypeInput.value = event.type;
            if (eventTimeInput) eventTimeInput.value = event.time || '';
            if (eventLocationInput) eventLocationInput.value = event.location || '';
            if (eventDescriptionInput) eventDescriptionInput.value = event.description || '';
        }
    }
    
    updateFormByEventType();
    openModal(eventModal);
}

// Abrir modal para crear comunicado
function openAnnouncementModal() {
    console.log('Abriendo modal de comunicados');
    
    if (announcementForm) {
        announcementForm.reset();
    }
    if (announcementDateInput) {
        announcementDateInput.valueAsDate = new Date();
    }
    
    openModal(announcementModal);
}

// Abrir modal
function openModal(modal) {
    if (modal) {
        console.log('Mostrando modal');
        modal.classList.add('active');
        document.body.style.overflow = 'hidden'; // Prevenir scroll del body
    }
}

// Cerrar modal
function closeModal(modal) {
    if (modal) {
        console.log('Cerrando modal');
        modal.classList.remove('active');
        document.body.style.overflow = ''; // Restaurar scroll del body
    }
}

// Actualizar formulario seg√∫n tipo de evento seleccionado
function updateFormByEventType() {
    if (!eventTypeInput || !eventDescriptionInput) return;
    
    const type = eventTypeInput.value;
    const descriptionLabel = document.querySelector('#description-group label');
    
    if (type === 'announcement' && descriptionLabel) {
        descriptionLabel.innerHTML = 'Contenido del comunicado <span class="optional-label">(obligatorio)</span>';
        eventDescriptionInput.required = true;
        eventDescriptionInput.placeholder = "Escribe aqu√≠ el contenido completo del comunicado...";
    } else if (descriptionLabel) {
        descriptionLabel.innerHTML = 'Descripci√≥n <span class="optional-label">(opcional)</span>';
        eventDescriptionInput.required = false;
        eventDescriptionInput.placeholder = "Detalles del evento...";
    }
}

// Guardar evento
function saveEvent(e) {
    e.preventDefault();
    
    const eventId = eventIdInput.value;
    const date = eventDateInput.value;
    const title = eventTitleInput.value.trim();
    const type = eventTypeInput.value;
    const time = eventTimeInput ? eventTimeInput.value : '';
    const location = eventLocationInput ? eventLocationInput.value.trim() : '';
    const description = eventDescriptionInput ? eventDescriptionInput.value.trim() : '';
    
    if (!title) {
        alert('Por favor, ingresa un t√≠tulo para el evento.');
        return;
    }
    
    if (type === 'announcement' && !description) {
        alert('Por favor, ingresa el contenido del comunicado.');
        return;
    }
    
    // Actualizar contadores de d√≠as
    if (!eventId) {
        if (type === 'vacation') {
            if (vacationDays > 0) {
                vacationDays--;
            } else {
                alert('No tienes m√°s d√≠as de vacaciones disponibles.');
                return;
            }
        } else if (type === 'admin') {
            if (adminDays > 0) {
                adminDays--;
            } else {
                alert('No tienes m√°s d√≠as administrativos disponibles.');
                return;
            }
        }
    } else {
        const oldEvent = events.find(e => e.id === eventId);
        if (oldEvent && oldEvent.type !== type) {
            if (oldEvent.type === 'vacation') vacationDays++;
            else if (oldEvent.type === 'admin') adminDays++;
            
            if (type === 'vacation') {
                if (vacationDays > 0) vacationDays--;
                else {
                    alert('No tienes m√°s d√≠as de vacaciones disponibles.');
                    if (oldEvent.type === 'vacation') vacationDays--;
                    else if (oldEvent.type === 'admin') adminDays--;
                    return;
                }
            } else if (type === 'admin') {
                if (adminDays > 0) adminDays--;
                else {
                    alert('No tienes m√°s d√≠as administrativos disponibles.');
                    if (oldEvent.type === 'vacation') vacationDays--;
                    else if (oldEvent.type === 'admin') adminDays--;
                    return;
                }
            }
        }
    }
    
    // Crear o actualizar evento
    if (eventId) {
        const eventIndex = events.findIndex(e => e.id === eventId);
        if (eventIndex !== -1) {
            events[eventIndex] = {
                ...events[eventIndex],
                title,
                type,
                time,
                location,
                description
            };
        }
    } else {
        const newEvent = {
            id: Date.now().toString(),
            date,
            title,
            type,
            time,
            location,
            description,
            category: 'event'
        };
        events.push(newEvent);
        
        if (type === 'announcement') {
            const newAnnouncement = {
                id: newEvent.id,
                date,
                title,
                content: description,
                author: 'Director/a',
                timestamp: new Date().toISOString()
            };
            announcements.unshift(newAnnouncement);
            localStorage.setItem('calendarAnnouncements', JSON.stringify(announcements));
        }
    }
    
    localStorage.setItem('calendarEvents', JSON.stringify(events));
    
    updateDayCounts();
    renderCalendar();
    
    if (type === 'announcement') {
        loadAnnouncements();
    }
    
    closeModal(eventModal);
    alert(type === 'announcement' ? 'Comunicado publicado exitosamente.' : 'Evento guardado exitosamente.');
}

// Guardar comunicado
function saveAnnouncement(e) {
    e.preventDefault();
    
    const title = announcementTitleInput ? announcementTitleInput.value.trim() : '';
    const content = announcementContentInput ? announcementContentInput.value.trim() : '';
    const date = announcementDateInput ? announcementDateInput.value : '';
    
    if (!title) {
        alert('Por favor, ingresa un t√≠tulo para el comunicado.');
        return;
    }
    
    if (!content) {
        alert('Por favor, ingresa el contenido del comunicado.');
        return;
    }
    
    const newAnnouncement = {
        id: Date.now().toString(),
        date,
        title,
        content,
        author: 'Director/a',
        timestamp: new Date().toISOString()
    };
    
    announcements.unshift(newAnnouncement);
    
    const newEvent = {
        id: newAnnouncement.id,
        date,
        title: `üì¢ ${title}`,
        type: 'announcement',
        description: content,
        category: 'announcement'
    };
    events.push(newEvent);
    
    localStorage.setItem('calendarAnnouncements', JSON.stringify(announcements));
    localStorage.setItem('calendarEvents', JSON.stringify(events));
    
    renderCalendar();
    loadAnnouncements();
    closeModal(announcementModal);
    
    alert('Comunicado publicado exitosamente.');
}

// Reiniciar eventos y contadores
function resetEvents() {
    if (confirm('¬øEst√°s seguro de que quieres reiniciar todos los eventos y comunicados? Esto eliminar√° toda la informaci√≥n del calendario.')) {
        events = [];
        announcements = [];
        vacationDays = 10;
        adminDays = 5;
        
        localStorage.removeItem('calendarEvents');
        localStorage.removeItem('calendarAnnouncements');
        
        updateDayCounts();
        renderCalendar();
        loadAnnouncements();
        
        alert('Todos los eventos y comunicados han sido eliminados.');
    }
}

// Actualizar contadores de d√≠as
function updateDayCounts() {
    if (vacationDaysEl) vacationDaysEl.textContent = vacationDays;
    if (adminDaysEl) adminDaysEl.textContent = adminDays;
    if (totalDaysEl) totalDaysEl.textContent = vacationDays + adminDays;
}

// Cargar comunicados
function loadAnnouncements() {
    if (!announcementsListEl) return;
    
    announcementsListEl.innerHTML = '';
    
    const sortedAnnouncements = [...announcements].sort((a, b) => 
        new Date(b.timestamp) - new Date(a.timestamp)
    );
    
    if (announcementsCountEl) {
        announcementsCountEl.textContent = `(${sortedAnnouncements.length})`;
    }
    
    if (sortedAnnouncements.length === 0) {
        announcementsListEl.innerHTML = `
            <div class="no-announcements">
                <i class="fas fa-bullhorn"></i>
                <p>No hay comunicados publicados a√∫n</p>
            </div>
        `;
        return;
    }
    
    const announcementsToShow = sortedAnnouncements.slice(0, 5);
    
    announcementsToShow.forEach(announcement => {
        const date = new Date(announcement.date);
        const formattedDate = date.toLocaleDateString('es-ES', {
            day: 'numeric',
            month: 'short',
            year: 'numeric'
        });
        
        const shortContent = announcement.content.length > 100 
            ? announcement.content.substring(0, 100) + '...' 
            : announcement.content;
        
        const announcementItem = document.createElement('div');
        announcementItem.className = 'announcement-item';
        announcementItem.innerHTML = `
            <div class="announcement-header">
                <div class="announcement-title">${announcement.title}</div>
                <div class="announcement-date">${formattedDate}</div>
            </div>
            <div class="announcement-content">${shortContent}</div>
            <div class="announcement-author">
                <div class="author-avatar">
                    <i class="fas fa-user-tie"></i>
                </div>
                <span>${announcement.author}</span>
            </div>
        `;
        
        announcementsListEl.appendChild(announcementItem);
    });
}

// Inicializar la aplicaci√≥n cuando se carga la p√°gina
document.addEventListener('DOMContentLoaded', init);
    </script>
{% endblock %}