{% extends "base/base.html" %}
{% load static %}

{% block title %}Calendario — Intranet CESFAM{% endblock %}

{% block extra_css %}
    <style>
        /* ======== CALENDARIO CUADRÍCULA ======== */
        .calendar-wrapper{max-width:1280px;margin:0 auto;padding:2rem 1.5rem;}
        .calendar-container{background:white;border-radius:16px;box-shadow:0 2px 8px rgba(0,0,0,0.1);padding:2rem;}
        .calendar-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;}
        .calendar-header h2{font-size:1.5rem;font-weight:700;color:#1a1a1a;}
        .calendar-nav button{background:#66b2ff;color:white;border:none;padding:0.5rem 1rem;border-radius:10px;cursor:pointer;font-weight:500;margin-left:0.5rem;transition:background 0.3s;}
        .calendar-nav button:hover{background:#4a9eea;}
        .weekdays, .days{display:grid;grid-template-columns:repeat(7,1fr);}
        .weekdays div, .days div{padding:1rem;border:1px solid #eee;text-align:center;min-height:80px;position:relative;border-radius:8px;}
        .weekdays div{background:#e3f2fd;font-weight:600;}
        .days div:hover{background:#f5faff;cursor:pointer;}
        .day-number{position:absolute;top:5px;left:5px;font-weight:600;color:#1a1a1a;}
        .event{margin-top:22px;font-size:0.8rem;padding:0.2rem 0.5rem;background:#7fffd4;border-radius:6px;color:#1a1a1a;cursor:pointer;display:flex;justify-content:space-between;align-items:center;transition:transform 0.2s;}
        .event:hover{transform:scale(1.05);}
        .event button{background:none;border:none;color:#dc2626;cursor:pointer;margin-left:5px;font-weight:700;}
        .add-event-btn{background:#66b2ff;color:white;border:none;padding:0.5rem 1rem;border-radius:10px;cursor:pointer;font-weight:500;margin-bottom:1rem;transition:background 0.3s;}
        .add-event-btn:hover{background:#4a9eea;}

        /* Modal */
        .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);align-items:center;justify-content:center;z-index:2000;}
        .modal.active{display:flex;}
        .modal-content{background:white;padding:2rem;border-radius:16px;min-width:300px;max-width:420px;position:relative;}
        .modal-content h3{margin-bottom:1rem;}
        .modal-content label{display:block;margin-top:0.5rem;margin-bottom:0.25rem;font-weight:500;}
        .modal-content input, .modal-content select{width:100%;padding:0.5rem;border-radius:8px;border:1px solid #ccc;margin-bottom:0.5rem;}
        .modal-content button{margin-top:1rem;padding:0.5rem 1rem;border:none;border-radius:8px;cursor:pointer;font-weight:500;}
        .modal-close{position:absolute;top:10px;right:10px;background:none;border:none;font-size:1.2rem;cursor:pointer;color:#666;}

        @media(max-width:768px){.days div{min-height:60px;font-size:0.85rem;}}
    </style>
    {% endblock %}

    {% block content %}
    <section class="calendar-wrapper">
        <h2 class="mb-2">Calendario Institucional</h2>

        <div class="calendar-container">
        <div class="calendar-header">
            <h2 id="monthYear">Mes Año</h2>
            <div class="calendar-nav">
            <button id="prevMonthBtn"><i class="fa-solid fa-chevron-left"></i> Mes Anterior</button>
            <button id="nextMonthBtn">Mes Siguiente <i class="fa-solid fa-chevron-right"></i></button>
            </div>
        </div>

        <button class="add-event-btn" id="addEventBtn">+ Agregar Evento</button>

        <div class="weekdays">
            <div>Lun</div><div>Mar</div><div>Mié</div><div>Jue</div><div>Vie</div><div>Sáb</div><div>Dom</div>
        </div>
        <div class="days" id="calendarDays"></div>
        </div>
    </section>

    <!-- Modal -->
    <div class="modal" id="eventModal">
        <div class="modal-content">
        <button class="modal-close" id="closeModalBtn">&times;</button>
        <h3 id="modalTitle">Agregar Evento</h3>
        <label>Nombre del evento:</label>
        <input type="text" id="eventName" placeholder="Ej: Reunión de Jefatura">
        <label>Fecha:</label>
        <input type="date" id="eventDate">
        <label>Tipo:</label>
        <select id="eventType">
            <option value="Reunión">Reunión</option>
            <option value="Capacitación">Capacitación</option>
            <option value="Feriado">Feriado</option>
        </select>
        <button id="saveEventBtn">Guardar</button>
        </div>
    </div>
    {% endblock %}

    {% block extra_js %}
    <script>
        // ===== Datos de ejemplo (reemplazables por API) =====
        let events = [
        {id:1,date:"2025-10-15",name:"Reunión de Jefaturas",type:"Reunión"},
        {id:2,date:"2025-10-20",name:"Capacitación Primeros Auxilios",type:"Capacitación"},
        {id:3,date:"2025-10-25",name:"Feriado Nacional",type:"Feriado"}
        ];

        // ===== Estado del calendario =====
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let editId = null;

        // ===== Utilidades DOM =====
        const $ = (sel) => document.querySelector(sel);
        const $$ = (sel) => document.querySelectorAll(sel);

        function generateCalendar(month, year){
        const calendarDays = $("#calendarDays");
        calendarDays.innerHTML = "";

        const firstDay = new Date(year, month, 1).getDay();        // 0=Dom..6=Sáb
        const totalDays = new Date(year, month+1, 0).getDate();

        // Título Mes/Año
        $("#monthYear").textContent = new Date(year, month)
            .toLocaleString('es-ES', { month: 'long', year: 'numeric' });

        // Ajuste para empezar Lunes (0=Dom → 6, otro → -1)
        let start = (firstDay === 0) ? 6 : firstDay - 1;

        // Relleno en blanco
        for(let i=0;i<start;i++) calendarDays.appendChild(document.createElement("div"));

        // Días del mes
        for(let day=1;day<=totalDays;day++){
            const dayDiv = document.createElement("div");
            const dayNumber = document.createElement("div");
            dayNumber.classList.add("day-number");
            dayNumber.textContent = day;
            dayDiv.appendChild(dayNumber);

            const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;

            // Render eventos
            events.filter(ev=>ev.date===dateStr).forEach(ev=>{
            const evDiv = document.createElement("div");
            evDiv.classList.add("event");
            evDiv.textContent = ev.name;

            const delBtn = document.createElement("button");
            delBtn.textContent="x";
            delBtn.title = "Eliminar";
            delBtn.onclick = (e)=>{ e.stopPropagation(); deleteEvent(ev.id); };

            evDiv.appendChild(delBtn);
            evDiv.onclick = ()=>{ openModal(ev); };
            dayDiv.appendChild(evDiv);
            });

            calendarDays.appendChild(dayDiv);
        }
        }

        function changeMonth(delta){
        currentMonth += delta;
        if(currentMonth < 0){currentMonth=11; currentYear--;}
        if(currentMonth > 11){currentMonth=0; currentYear++;}
        generateCalendar(currentMonth,currentYear);
        }

        // ===== Modal =====
        function openModal(eventObj=null){
        $("#eventModal").classList.add("active");
        if(eventObj){
            editId = eventObj.id;
            $("#modalTitle").textContent="Editar Evento";
            $("#eventName").value = eventObj.name;
            $("#eventDate").value = eventObj.date;
            $("#eventType").value = eventObj.type;
        }else{
            editId = null;
            $("#modalTitle").textContent="Agregar Evento";
            $("#eventName").value="";
            $("#eventDate").value="";
            $("#eventType").value="Reunión";
        }
        }
        function closeModal(){ $("#eventModal").classList.remove("active"); }

        function saveEvent(){
        const name = $("#eventName").value.trim();
        const date = $("#eventDate").value;
        const type = $("#eventType").value;
        if(!name || !date){ alert("Complete todos los campos."); return; }

        if(editId){
            const ev = events.find(e=>e.id===editId);
            ev.name=name; ev.date=date; ev.type=type;
        }else{
            const id = events.length ? Math.max(...events.map(e=>e.id))+1 : 1;
            events.push({id,date,name,type});
        }
        closeModal();
        generateCalendar(currentMonth,currentYear);
        }

        function deleteEvent(id){
        if(confirm("¿Eliminar este evento?")){
            events = events.filter(e=>e.id!==id);
            generateCalendar(currentMonth,currentYear);
        }
        }

        // ===== Eventos UI =====
        document.addEventListener('DOMContentLoaded', () => {
        $("#prevMonthBtn").addEventListener("click", () => changeMonth(-1));
        $("#nextMonthBtn").addEventListener("click", () => changeMonth(1));
        $("#addEventBtn").addEventListener("click", () => openModal());
        $("#saveEventBtn").addEventListener("click", saveEvent);
        $("#closeModalBtn").addEventListener("click", closeModal);

        generateCalendar(currentMonth,currentYear);
        });
    </script>
{% endblock %}
