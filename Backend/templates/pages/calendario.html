{% extends "base/base.html" %}
{% load static %}

{% block extra_css %} 
    <link rel="stylesheet" href="{% static 'css/calendario.css' %}">
{%endblock%}

{% block content %}
        <div class="calendar-layout">
        <!-- IZQUIERDA: Calendario -->
        <div class="calendar-container">
            <div class="page-cal">
            <h2 class="title">Calendario</h2>

            <!-- Formulario crear evento -->
            <section class="card form-card">
                <form id="form-nuevo" class="form-grid">
                {% csrf_token %}
                <input type="text" id="titulo" placeholder="T√≠tulo" required />
                <input type="date" id="fecha" required />
                <!-- <input type="text" id="color" value="#3A8DFF" placeholder="#3A8DFF" /> -->
                <textarea id="desc" placeholder="Descripci√≥n (opcional)"></textarea>
                <button type="submit" class="btn-primary">Crear evento</button>
                </form>
            </section>

            <!-- Switcher Mes / Lista (dejamos "Mes" para la grilla de calendario) -->
            <section class="card switcher">
                <div class="tabs">
                <button id="tab-mes" class="active">Mes</button>
                <button id="tab-lista" type="button">Lista</button> <!-- si quieres, puede alternar a la derecha -->
                </div>

                <!-- Controles de mes -->
                <div id="month-controls" class="month-controls">
                <button id="prev-month" class="btn-icon" title="Mes anterior">‚óÄ</button>
                <div id="month-label"></div>
                <button id="next-month" class="btn-icon" title="Mes siguiente">‚ñ∂</button>
                <button id="today-month" class="btn-ghost">Hoy</button>
                </div>

                <!-- Vista mensual -->
                <div id="month-grid" class="month-grid">
                <div class="dow">Lun</div><div class="dow">Mar</div><div class="dow">Mi√©</div>
                <div class="dow">Jue</div><div class="dow">Vie</div><div class="dow">S√°b</div><div class="dow">Dom</div>
                <!-- Celdas din√°micas por JS -->
                </div>
            </section>
            </div>
        </div>

        <!-- DERECHA: Lista de eventos como sidebar -->
        <aside class="event-list-container">
            <div class="card">
            <div class="list-head" style="display:flex;justify-content:space-between;align-items:center;gap:.5rem">
                <h3 style="margin:0">Eventos</h3>
                <div class="filters" style="display:flex;gap:.5rem">
                <input type="date" id="filtro-start" />
                <input type="date" id="filtro-end" />
                <button id="btn-filtrar" class="btn-light">Filtrar</button>
                <button id="btn-limpiar" class="btn-ghost">Limpiar</button>
                </div>
            </div>

            <ul id="items" class="items"></ul>
            <div id="empty" class="empty-state" hidden>
                <div class="dot"></div>
                <p>No hay eventos todav√≠a. Crea el primero con el formulario de arriba.</p>
            </div>
            </div>
        </aside>
        </div>

    {% endblock %}

    {% block extra_js %}
    <script>
    // ====== CSRF ======
    function getCookie(name){ const m=document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)'); return m?m.pop():''; }
    function getCsrf(){
        const c = getCookie('csrftoken'); 
        if (c) return c;
        const hidden = document.querySelector('input[name=csrfmiddlewaretoken]');
        return hidden ? hidden.value : '';
    }
    const csrftoken = getCsrf();

    // ====== LISTA ======
    const ul = document.getElementById('items');
    const empty = document.getElementById('empty');
    function liTemplate(e){
        return `
        <li class="item" data-id="${e.id}">
            <div class="left">
            <span class="badge" style="background:${e.color||'#3A8DFF'}"></span>
            <div class="meta">
                <strong>${e.titulo}</strong>
                <span class="date">${e.fecha}</span>
                ${e.descripcion ? `<div class="desc">${e.descripcion}</div>` : ''}
            </div>
            </div>
            <div class="actions">
            <button class="edit">Editar</button>
            <button class="del danger">Eliminar</button>
            </div>
        </li>`;
    }
    function toggleEmpty(hasItems){ empty.hidden = hasItems; }
    async function load(query=''){
        const res = await fetch(`/api/eventos/${query}`);
        const data = await res.json();
        const items = (data.results||[]);
        ul.innerHTML = items.map(liTemplate).join('');
        toggleEmpty(items.length>0);
    }

    // Crear
    document.getElementById('form-nuevo').addEventListener('submit', async (ev)=>{
        ev.preventDefault();
        const rawDate = document.getElementById('fecha').value;
        const iso = rawDate ? new Date(rawDate).toISOString().slice(0,10) : '';
        const payload = {
        titulo: document.getElementById('titulo').value.trim(),
        fecha: iso,
        color: document.getElementById('color')?.value || '#3A8DFF',
        descripcion: document.getElementById('desc').value || ''
        };
        if(!payload.titulo || !payload.fecha) return alert('Completa t√≠tulo y fecha.');
        const res = await fetch('/api/eventos/', {
        method:'POST',
        headers:{'Content-Type':'application/json','X-CSRFToken': csrftoken},
        body: JSON.stringify(payload)
        });
        if(res.ok){ ev.target.reset(); await load(); await loadMonth(); }
        else alert(await res.text());
    });

    // Editar / Eliminar
    ul.addEventListener('click', async ev=>{
        const li = ev.target.closest('.item'); if(!li) return;
        const id = li.dataset.id;

        if(ev.target.classList.contains('del')){
        if(!confirm('¬øEliminar este evento?')) return;
        const res = await fetch(`/api/eventos/${id}/`, { method:'DELETE', headers:{'X-CSRFToken': csrftoken }});
        if(res.ok){ li.remove(); toggleEmpty(ul.children.length>0); await loadMonth(); }
        else alert(await res.text());
        }

        if(ev.target.classList.contains('edit')){
        const currentTitle = li.querySelector('strong').textContent;
        const currentDate = li.querySelector('.date').textContent;
        const titulo = prompt('Nuevo t√≠tulo:', currentTitle); if(!titulo) return;
        const fecha = prompt('Nueva fecha (YYYY-MM-DD):', currentDate); if(!fecha) return;
        const res = await fetch(`/api/eventos/${id}/`, {
            method:'PUT',
            headers:{'Content-Type':'application/json','X-CSRFToken':csrftoken},
            body: JSON.stringify({ titulo, fecha })
        });
        if(res.ok){ load(); loadMonth(); } else alert(await res.text());
        }
    });

    // Filtros lista
    document.getElementById('btn-filtrar').addEventListener('click', ()=>{
        const s = document.getElementById('filtro-start').value;
        const e = document.getElementById('filtro-end').value;
        const q = (s||e) ? `?${s?`start=${s}`:''}${s&&e?'&':''}${e?`end=${e}`:''}` : '';
        load(q);
    });
    document.getElementById('btn-limpiar').addEventListener('click', ()=>{
        document.getElementById('filtro-start').value=''; document.getElementById('filtro-end').value='';
        load();
    });

    // ====== MES ======
    const fmt = (d)=> d.toISOString().slice(0,10);
    function firstDayOfMonth(d){ return new Date(d.getFullYear(), d.getMonth(), 1); }
    function lastDayOfMonth(d){ return new Date(d.getFullYear(), d.getMonth()+1, 0); }
    function mondayOfWeek(d){ const t=new Date(d), k=(t.getDay()||7); if(k>1) t.setDate(t.getDate()-(k-1)); return t; }
    function sundayOfWeek(d){ const t=new Date(d), k=(t.getDay()||7); if(k<7) t.setDate(t.getDate()+(7-k)); return t; }
    function monthLabel(d){ return d.toLocaleDateString('es-CL',{month:'long',year:'numeric'}).replace(/^\w/, c=>c.toUpperCase()); }

    const monthGrid = document.getElementById('month-grid');
    const monthLabelEl = document.getElementById('month-label');
    const prevBtn = document.getElementById('prev-month');
    const nextBtn = document.getElementById('next-month');
    const todayBtn = document.getElementById('today-month');
    const tabMes = document.getElementById('tab-mes');
    const tabLista = document.getElementById('tab-lista');
    const listView = document.getElementById('list-view');

    let current = new Date();

    async function loadMonth(){
        const start = mondayOfWeek(firstDayOfMonth(current));
        const end   = sundayOfWeek(lastDayOfMonth(current));

        const res = await fetch(`/api/eventos/?start=${fmt(start)}&end=${fmt(end)}`);
        const data = await res.json();
        const map = new Map();
        for(const e of (data.results||[])){ const k=e.fecha; if(!map.has(k)) map.set(k,[]); map.get(k).push(e); }

        monthLabelEl.textContent = monthLabel(current);
        while (monthGrid.children.length > 7) monthGrid.removeChild(monthGrid.lastChild);

        const endCopy = new Date(end);
        for(let d=new Date(start); d<=endCopy; d.setDate(d.getDate()+1)){
        const cell = document.createElement('div');
        cell.className = 'day' + (d.getMonth()!==current.getMonth() ? ' out':'');
        const dateStr = fmt(d);
        // üîπ Marca el d√≠a de hoy
        if (d.toDateString() === new Date().toDateString()) {
        cell.classList.add('today');
        }
        const head = document.createElement('div');
        head.className = 'date';
        head.textContent = d.getDate();
        cell.appendChild(head);

        for(const ev of (map.get(dateStr)||[])){
            const a = document.createElement('a');
            a.className = 'event-pill';
            a.title = ev.descripcion || '';
            a.innerHTML = `<span class="dot" style="background:${ev.color||'#3A8DFF'}"></span>${ev.titulo}`;
            a.href = 'javascript:void(0)';
            a.addEventListener('click', ()=> {
            const nuevoTitulo = prompt('Editar t√≠tulo:', ev.titulo);
            if(!nuevoTitulo) return;
            fetch(`/api/eventos/${ev.id}/`, {
                method:'PUT',
                headers:{'Content-Type':'application/json','X-CSRFToken': csrftoken},
                body: JSON.stringify({ titulo: nuevoTitulo, fecha: ev.fecha })
            }).then(loadMonth);
            });
            cell.appendChild(a);
        }
        monthGrid.appendChild(cell);
        }
    }

    function showMes(){
        tabMes.classList.add('active'); tabLista.classList.remove('active');
        monthGrid.hidden = false; document.getElementById('month-controls').style.display='flex';
        listView.hidden = true; loadMonth();
    }
    function showLista(){
        tabLista.classList.add('active'); tabMes.classList.remove('active');
        monthGrid.hidden = true; document.getElementById('month-controls').style.display='none';
        listView.hidden = false; load();
    }

    tabMes?.addEventListener('click', showMes);
    tabLista?.addEventListener('click', showLista);
    prevBtn?.addEventListener('click', ()=>{ current=new Date(current.getFullYear(), current.getMonth()-1, 1); loadMonth(); });
    nextBtn?.addEventListener('click', ()=>{ current=new Date(current.getFullYear(), current.getMonth()+1, 1); loadMonth(); });
    todayBtn?.addEventListener('click', ()=>{ current=new Date(); loadMonth(); });

    // UX: valor por defecto hoy en el form
    document.getElementById('fecha').valueAsDate = new Date();

    // Arranque por defecto en ‚ÄúMes‚Äù
    showMes();
    </script>
{% endblock %}
