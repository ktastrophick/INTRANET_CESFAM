{% extends "base/base.html" %}
{% load static %}

{% block title %}Documentos — Intranet CESFAM{% endblock %}

{% block extra_css %}
  <style>
    .documentos-container{background:#fff;border-radius:16px;box-shadow:0 2px 8px rgba(0,0,0,.1);padding:2rem}
    .documentos-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem}
    .documentos-header h2{font-size:1.5rem;font-weight:700;color:#1a1a1a}
    .upload-btn{background:linear-gradient(135deg,#66b2ff 0%,#7fffd4 100%);color:#fff;border:none;padding:.75rem 1.5rem;border-radius:10px;cursor:pointer;font-weight:500;transition:transform .3s,opacity .3s}
    .upload-btn:hover{opacity:.9;transform:translateY(-2px)}
    .filters{display:flex;flex-wrap:wrap;gap:1rem;background:#f5f5f5;border-radius:12px;padding:1rem;margin-bottom:1.5rem}
    .filters input,.filters select{padding:.6rem;border:1px solid #ddd;border-radius:8px;font-size:.9rem;flex:1;min-width:180px}
    .filters button{background:#66b2ff;color:#fff;border:none;padding:.6rem 1.2rem;border-radius:8px;cursor:pointer;font-weight:500;transition:background .3s}
    .filters button:hover{background:#4a9eea}
    table{width:100%;border-collapse:collapse;border-radius:12px;overflow:hidden}
    th,td{padding:1rem;text-align:left;border-bottom:1px solid #eee}
    th{background:#2563eb;color:#fff;font-weight:600}
    tr:hover{background:#f5faff}
    .documento-actions i{margin-right:.5rem;cursor:pointer;color:#2563eb;transition:color .3s}
    .documento-actions i:hover{color:#1e88e5}
    .messages{margin-bottom:1rem}
    .messages p{margin:0 0 .25rem 0;font-weight:600;font-size:.9rem}
    .messages .error{color:#b91c1c}
    .messages .success{color:#15803d}
    @media (max-width: 768px){
      .filters{flex-direction:column}
      th,td{font-size:.85rem}
      .documentos-header{flex-direction:column;align-items:flex-start;gap:1rem}
      .upload-btn{width:100%}
    }
  </style>
{% endblock %}

{% block content %}
  <section class="page-content">
    <div class="documentos-container">

      {# Mensajes de Django #}
      {% if messages %}
        <div class="messages">
          {% for message in messages %}
            <p class="{{ message.tags }}">{{ message }}</p>
          {% endfor %}
        </div>
      {% endif %}

      <div class="documentos-header">
        <h2>Gestión de Documentos Institucionales</h2>

        {# Solo Admin puede subir documentos (según lógica de views) #}
        {% if usuario.id_rol and usuario.id_rol.nombre == "Admin" %}
        <a href="{% url 'form_documento' %}">
          <button class="upload-btn">
            <i class="fa-solid fa-plus"></i> Subir documento
          </button>
        </a>
        {% endif %}
      </div>

      <div class="filters">
        <input type="text" id="filtroNombre" placeholder="Buscar por nombre…" value="{{ query|default:'' }}">
        <select id="filtroTipo">
          <option value="">Tipo de archivo</option>
          <option value="pdf">PDF</option>
          <option value="word">Word</option>
          <option value="excel">Excel</option>
        </select>
        <input type="date" id="filtroFecha">
        <button id="btnFiltrar" type="button">Filtrar</button>
        <button id="btnLimpiar" type="button">Limpiar</button>
      </div>

      <table id="tablaDocumentos">
        <thead>
          <tr>
            <th>Nombre del Documento</th>
            <th>Tipo</th>
            <th>Fecha</th>
            <th>Funcionario</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for d in api_intranet_documento %}
            <tr>
              <td>{{ d.nombre }}</td>

              <td>
                {% if d.archivo.url|lower|slice:"-4:" == ".pdf" %}
                    PDF
                {% elif d.archivo.url|lower|slice:"-4:" == ".doc" or d.archivo.url|lower|slice:"-5:" == ".docx" %}
                    Word
                {% elif d.archivo.url|lower|slice:"-4:" == ".xls" or d.archivo.url|lower|slice:"-5:" == ".xlsx" %}
                    Excel
                {% else %}
                    Otro
                {% endif %}
              </td>

              <td>{{ d.fecha_subida|date:"Y-m-d" }}</td>
              <td>{{ d.subido_por.nombre }}</td>

              <td>
                  <a href="{{ d.archivo.url }}" download>
                      <i class="fa-solid fa-download" title="Descargar"></i>
                  </a>

                  <div class="documento-actions">
                      {# Solo Admin puede editar/eliminar según tu lógica de permisos #}
                      {% if usuario.id_rol and usuario.id_rol.nombre == "Admin" %}
                      <a href="{% url 'editar_documento' d.id_documento %}">
                          <i class="fa-solid fa-pen" title="Editar"></i>
                      </a>
                      {% endif %}

                      <a href="mailto:{{ d.subido_por.correo }}">
                          <i class="fa-solid fa-envelope" title="Enviar mensaje"></i>
                      </a>

                      {% if usuario.id_rol and usuario.id_rol.nombre == "Admin" %}
                      <a href="{% url 'eliminar_documento' d.id_documento %}">
                          <i class="fa-solid fa-trash" title="Eliminar"></i>
                      </a>
                      {% endif %}
                  </div>
              </td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="5" style="text-align:center; padding:1.5rem;">
                No hay documentos registrados.
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>
{% endblock %}

{% block extra_js %}
  <script>
    const $  = (sel) => document.querySelector(sel);
    const $$ = (sel) => document.querySelectorAll(sel);

    function filtrar() {
      const nombre = $('#filtroNombre').value.toLowerCase();
      const tipo   = $('#filtroTipo').value.toLowerCase();
      const fecha  = $('#filtroFecha').value;

      $$('#tablaDocumentos tbody tr').forEach(tr => {
        const nombreDoc = tr.children[0].textContent.toLowerCase();
        const tipoDoc   = tr.children[1].textContent.toLowerCase();
        const fechaDoc  = tr.children[2].textContent;

        const okNombre  = !nombre || nombreDoc.includes(nombre);
        const okTipo    = !tipo   || tipoDoc.includes(tipo);
        const okFecha   = !fecha  || fechaDoc === fecha;

        tr.style.display = (okNombre && okTipo && okFecha) ? '' : 'none';
      });
    }

    function limpiarFiltros(){
      $('#filtroNombre').value = '';
      $('#filtroTipo').value   = '';
      $('#filtroFecha').value  = '';
      filtrar();
    }

    document.addEventListener('DOMContentLoaded', () => {
      $('#btnFiltrar').addEventListener('click', filtrar);
      $('#btnLimpiar').addEventListener('click', limpiarFiltros);
    });
  </script>
{% endblock %}
