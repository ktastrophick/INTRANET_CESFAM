{% extends "base/base.html" %}
{% load static %}

{% block title %}Dashboard — Intranet CESFAM{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/index.css' %}">
<!-- Bootstrap 5 CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    :root {
        --primary: #0B2C4A;
        --secondary: #134181ff;
        --accent: #2E8B57;
        --danger: #ef4444;
        --success: #38b000;
        --warning: #f8961e;
        --info: #7209b7;
        --light: #f8f9fa;
        --dark: #212529;
        --border-radius: 12px;
        --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        --transition: all 0.3s ease;
    }

    body {
        background-color: #f5f7fb;
        font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        color: #333;
        overflow-x: hidden;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
    }

    .page-content {
        flex: 1;
        padding: 0;
        max-width: 1200px;
        margin: 0 auto;
        width: 100%;
    }


    .view-profile-btn {
        color: var(--primary);
        text-decoration: none;
        font-weight: 500;
        font-size: 0.9rem;
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.5rem 1rem;
        border: 1px solid var(--primary);
        border-radius: 20px;
        transition: var(--transition);
    }

    .view-profile-btn:hover {
        background: var(--primary);
        color: white;
        text-decoration: none;
    }


    /* Información del usuario en header */
    .user-info {
        display: flex;
        align-items: center;
        gap: 1rem;
        cursor: pointer;
        padding: 0.5rem 0.75rem;
        border-radius: var(--border-radius);
        transition: var(--transition);
        position: relative;
        color: #F2F7FF;
    }

    .user-info:hover {
        background: rgba(255, 255, 255, 0.1);
    }



    .user-info:hover .user-avatar {
        background: rgba(255, 255, 255, 0.3);
    }


    .user-info::after {
        content: '';
        width: 6px;
        height: 6px;
        border-right: 2px solid #CFE6FF;
        border-bottom: 2px solid #CFE6FF;
        transform: rotate(-45deg);
        margin-left: 0.5rem;
        opacity: 0.7;
        transition: var(--transition);
    }

    .user-info:hover::after {
        border-color: #F2F7FF;
    }

    /* Dashboard Container */
    .dashboard-container {
        flex: 1;
        padding: 0;
    }

    /* Widgets de comunicados */
    .announcement-item {
        padding: 0.75rem 0;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        transition: var(--transition);
        text-decoration: none;
        color: inherit;
        display: block;
    }

    .announcement-item:hover {
        background-color: rgba(11, 44, 74, 0.05);
        border-radius: 8px;
        padding-left: 0.5rem;
        text-decoration: none;
        color: inherit;
    }

    .announcement-item:last-child {
        border-bottom: none;
    }

    .see-more-link {
        color: var(--primary);
        text-decoration: none;
        font-weight: 500;
        font-size: 0.9rem;
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
    }

    .see-more-link:hover {
        color: #0a2440;
        text-decoration: underline;
    }

    /* Estado de solicitudes - Nuevo diseño */
    .requests-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
        margin-top: 1rem;
    }

    .request-item {
        background: white;
        border-radius: var(--border-radius);
        padding: 1.25rem;
        border-left: 4px solid var(--primary);
        transition: var(--transition);
        border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .request-item:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
    }

    .request-item--received {
        border-left-color: #2170beff;
        background: linear-gradient(135deg, #e3f2fd 0%, #f9fcff 100%);
    }

    .request-item--accepted {
        border-left-color: #4caf50;
        background: linear-gradient(135deg, #e8f5e8 0%, #f9fff9 100%);
    }

    .request-item--pending {
        border-left-color: #ff9800;
        background: linear-gradient(135deg, #fff3e0 0%, #fffcf7 100%);
    }

    .request-item--rejected {
        border-left-color: #f44336;
        background: linear-gradient(135deg, #ffebee 0%, #fff9f9 100%);
    }

    .request-label {
        font-size: 0.85rem;
        color: var(--secondary);
        font-weight: 500;
        margin-bottom: 0.25rem;
    }

    .request-value {
        font-size: 1.75rem;
        font-weight: 700;
        margin-bottom: 0.25rem;
    }

    .request-description {
        font-size: 0.8rem;
        color: var(--secondary);
    }

    .request-value--received { color: #2769acff; }
    .request-value--accepted { color: #4caf50; }
    .request-value--pending { color: #ff9800; }
    .request-value--rejected { color: #f44336; }

    /* Resumen días libres - ESTILOS NUEVOS */
    .days-breakdown {
        display: flex;
        flex-direction: column;
        gap: 15px;
        margin-top: 20px;
    }
    
    .days-type {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        border-radius: 10px;
        transition: transform 0.2s;
    }
    
    .vacation-days {
        background-color: rgba(46, 139, 87, 0.1);
        border-left: 6px solid var(--accent);
    }
    
    .admin-days {
        background-color: rgba(239, 68, 68, 0.1);
        border-left: 5px solid var(--danger);
    }
    
    .type-info {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .type-icon {
        font-size: 1.5rem;
    }
    
    .vacation-days .type-icon {
        color: var(--accent);
    }
    
    .admin-days .type-icon {
        color: var(--danger);
    }
    
    .type-name {
        font-weight: 600;
        font-size: 1rem;
    }
    
    .type-available {
        font-size: 1.5rem;
        font-weight: bold;
    }
    
    .vacation-days .type-available {
        color: var(--accent);
    }
    
    .admin-days .type-available {
        color: var(--danger);
    }
    
    .days-total {
        text-align: center;
        margin-bottom: 20px;
    }
    
    .days-available {
        font-size: 2.5rem;
        font-weight: bold;
        color: var(--primary);
        line-height: 1;
        margin-bottom: 5px;
    }
    
    .days-label {
        font-size: 1rem;
        color: var(--secondary);
    }

    /* Calendario */
    .calendar-mini {
        background: white;
        border-radius: var(--border-radius);
        padding: 1rem;
    }

    .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 0.25rem;
    }

    .calendar-day-header {
        text-align: center;
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--secondary);
        padding: 0.5rem 0;
    }

    .calendar-day {
        aspect-ratio: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 6px;
        font-size: 0.875rem;
        color: var(--dark);
        cursor: pointer;
        transition: var(--transition);
        position: relative;
    }

    .calendar-day:hover {
        background: rgba(11, 44, 74, 0.1);
    }

    .calendar-day.today {
        background: var(--primary);
        color: white;
        font-weight: 600;
    }
    
    .calendar-day.event-day {
        font-weight: 600;
    }
    
    .event-indicator {
        position: absolute;
        bottom: 2px;
        width: 4px;
        height: 4px;
        border-radius: 50%;
    }
    
    .vacation-indicator {
        background-color: var(--accent);
    }
    
    .admin-indicator {
        background-color: var(--danger);
    }

    /* Próximas actividades */
    .activities-list {
        max-height: 250px;
        overflow-y: auto;
        padding-right: 0.5rem;
    }

    .activity-item {
        padding: 0.75rem;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .activity-item:last-child {
        border-bottom: none;
    }

    .activity-date {
        min-width: 60px;
        text-align: center;
        background: rgba(11, 44, 74, 0.1);
        border-radius: 8px;
        padding: 0.5rem;
    }

    .activity-month {
        display: block;
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--primary);
    }

    .activity-day {
        display: block;
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--dark);
    }

    /* Dashboard cards */
    .dashboard-card {
        background: white;
        border-radius: var(--border-radius);
        padding: 1.5rem;
        box-shadow: var(--shadow);
        margin-bottom: 1.5rem;
        border: none;
        transition: var(--transition);
    }

    .dashboard-card:hover {
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
    }

    .card-title {
        font-weight: 600;
        color: var(--dark);
        margin-bottom: 1rem;
        font-size: 1.1rem;
    }

    /* MODAL PARA AGREGAR EVENTO */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s;
    }
    
    .modal-overlay.active {
        opacity: 1;
        visibility: visible;
    }
    
    .event-modal {
        background-color: white;
        border-radius: 15px;
        width: 90%;
        max-width: 450px;
        padding: 25px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        transform: translateY(-20px);
        transition: transform 0.3s;
    }
    
    .modal-overlay.active .event-modal {
        transform: translateY(0);
    }
    
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    
    .modal-title {
        font-size: 1.3rem;
        color: var(--primary);
    }
    
    .close-modal {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #999;
        transition: color 0.2s;
    }
    
    .close-modal:hover {
        color: var(--text-color);
    }
    
    .form-group {
        margin-bottom: 15px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 6px;
        font-weight: 600;
        font-size: 0.9rem;
    }
    
    .form-control {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid rgba(0, 0, 0, 0.1);
        border-radius: 8px;
        font-size: 0.9rem;
    }
    
    .form-control:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(11, 44, 74, 0.1);
    }
    
    .optional-label {
        color: #999;
        font-weight: normal;
    }
    
    .modal-actions {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        margin-top: 20px;
    }
    
    .btn {
        padding: 10px 20px;
        border-radius: 8px;
        border: none;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.9rem;
    }
    
    .btn-primary {
        background-color: var(--primary);
        color: white;
    }
    
    .btn-primary:hover {
        background-color: #0a2440;
    }
    
    .btn-secondary {
        background-color: #f0f0f0;
        color: var(--dark);
    }
    
    .btn-secondary:hover {
        background-color: #e0e0e0;
    }
    
    .event-actions {
        display: flex;
        justify-content: space-between;
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid rgba(0, 0, 0, 0.05);
    }
    
    .delete-btn {
        background-color: #ffebee;
        color: #d32f2f;
        border: 1px solid #ffcdd2;
        padding: 6px 12px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 0.8rem;
        transition: all 0.2s;
    }
    
    .delete-btn:hover {
        background-color: #ffcdd2;
    }

    /* Ajustes para mantener la barra de navegación del proyecto */
    .main-content-area {
        padding-top: 20px;
    }


    
    @media (max-width: 576px) {
        .requests-grid {
            grid-template-columns: 1fr;
        }
        
        .event-modal {
            width: 95%;
            padding: 20px;
        }
    }

    /* Scrollbar personalizado */
    ::-webkit-scrollbar {
        width: 6px;
    }

    ::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
    }
</style>
{% endblock %}

{% block content %}
<!-- Modal para agregar/editar eventos -->
<div class="modal-overlay" id="event-modal"></div>

<div class="dashboard-container">
    <!-- Banner de bienvenida -->
    <section class="welcome-banner" style="background: linear-gradient(135deg, var(--primary), #2b4a6f); color: white; border-radius: var(--border-radius); padding: 1.5rem; margin-bottom: 1.5rem;">
        {% with nombre=usuario.nombre|default:request.session.usuario_nombre %}
        <h2 class="welcome-banner__title" style="margin: 0 0 0.5rem 0;">
            ¡Bienvenido/a, {{ nombre }}!
        </h2>
        {% endwith %}
        <p class="welcome-banner__subtitle" style="margin: 0; opacity: 0.9;">
            Su espacio de gestión y comunicación interna del CESFAM Santa Rosa
        </p>
    </section>
    
    <!-- Área de widgets -->
    <div class="row g-3">
        <!-- Columna izquierda -->
        <div class="col-md-4">
            <!-- Comunicados Recientes -->
            <div class="dashboard-card">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3 class="card-title m-0">Comunicados Recientes</h3>
                    <a href="{% url 'comunicados' %}" class="see-more-link">
                        ver más <i class="bi bi-chevron-right"></i>
                    </a>
                </div>
                <div class="announcements-list">
                    {% if avisos %}
                        {% for aviso in avisos|slice:":3" %}
                            <a href="{% url 'comunicados' %}#aviso-{{ aviso.id_aviso }}"
                            class="announcement-item">

                                <div class="announcement-item__title">
                                    {{ aviso.titulo }}
                                </div>

                                <div class="announcement-item__meta">
                                    <i class="bi bi-calendar-event"></i>
                                    {{ aviso.fecha_registro|date:"d M Y" }}
                                    &nbsp;&nbsp;
                                    <i class="bi bi-person"></i>
                                    {{ aviso.id_usuario.nombre|default:"Dirección" }}
                                </div>
                            </a>
                        {% endfor %}
                    {% else %}
                        <div class="announcement-item text-center">
                            <i class="bi bi-megaphone fs-3 text-muted"></i>
                            <div class="fw-semibold mt-2">No hay comunicados recientes</div>
                            <div class="announcement-item__meta">
                                Los nuevos avisos aparecerán aquí
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Estado de Solicitudes -->
            <div class="dashboard-card">
                <h3 class="card-title">Estado de mis Solicitudes</h3>
                <div class="requests-grid">
                    <div class="request-item request-item--received">
                        <div class="request-label">Recibidas</div>
                        <div class="request-value request-value--received">{{ solicitudes_recibidas|default:"0" }}</div>
                        <div class="request-description">Total este mes</div>
                    </div>
                    
                    <div class="request-item request-item--accepted">
                        <div class="request-label">Aceptadas</div>
                        <div class="request-value request-value--accepted">{{ solicitudes_aceptadas|default:"0" }}</div>
                        <div class="request-description">Este período</div>
                    </div>
                    
                    <div class="request-item request-item--pending">
                        <div class="request-label">Pendientes</div>
                        <div class="request-value request-value--pending">{{ solicitudes_pendientes|default:"0" }}</div>
                        <div class="request-description">En revisión</div>
                    </div>
                    
                    <div class="request-item request-item--rejected">
                        <div class="request-label">Rechazadas</div>
                        <div class="request-value request-value--rejected">{{ solicitudes_rechazadas|default:"0" }}</div>
                        <div class="request-description">Este período</div>
                    </div>
                </div>
            </div>

            <!-- Resumen de días libres - MEJORADO -->
            <div class="dashboard-card">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3 class="card-title m-0">Resumen de días libres</h3>
                </div>
                
                <div class="days-total">
                    <div class="days-available" id="total-days">15</div>
                    <div class="days-label">Disponibles este año</div>
                </div>
                
                <div class="days-breakdown">
                    <div class="days-type vacation-days">
                        <div class="type-info">
                            <i class="fas fa-umbrella-beach type-icon"></i>
                            <div>
                                <div class="type-name">Días de Vacaciones</div>
                                <div class="type-desc"></div>
                            </div>
                        </div>
                        <div class="type-available" id="vacation-days">10</div>
                    </div>
                    
                    <div class="days-type admin-days">
                        <div class="type-info">
                            <i class="fas fa-briefcase type-icon"></i>
                            <div>
                                <div class="type-name">Días Administrativos</div>
                                <div class="type-desc"></div>
                            </div>
                        </div>
                        <div class="type-available" id="admin-days">5</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Columna derecha -->
        <div class="col-md-8">
            <!-- Calendario con funcionalidad de eventos -->
            <div class="dashboard-card">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3 class="card-title m-0">CALENDARIO</h3>
                    <a href="{% url 'calendario' %}" class="see-more-link">
                        Ver todos los eventos <i class="bi bi-chevron-right"></i>
                    </a>
                </div>
                <div class="calendar-mini">
                    <div class="calendar-header">
                        <button class="btn btn-sm btn-outline-primary" id="prevMonth">
                            <i class="bi bi-chevron-left"></i>
                        </button>
                        <h5 class="m-0" id="currentMonth">Octubre 2023</h5>
                        <button class="btn btn-sm btn-outline-primary" id="nextMonth">
                            <i class="bi bi-chevron-right"></i>
                        </button>
                    </div>
                    <div class="calendar-grid" id="calendarGrid">
                        <!-- Los días del calendario se generan con JavaScript -->
                    </div>
                    <div class="event-actions mt-3">
                        <div class="d-flex gap-2 align-items-center">
                            <div class="d-flex align-items-center gap-1">
                                <div style="width: 12px; height: 12px; background-color: #FF6B6B; border-radius: 2px;"></div>
                                <small>General</small>
                            </div>
                            <div class="d-flex align-items-center gap-1">
                                <div style="width: 12px; height: 12px; background-color: #3A8DFF; border-radius: 2px;"></div>
                                <small>Personal</small>
                            </div>
                        </div>
                        <div class="text-muted small">
                            <i class="bi bi-info-circle"></i> Haz clic para ver más detalles
                        </div>
                    </div>
                </div>
            </div>

            <!-- Próximos Eventos -->
            <div class="dashboard-card">
                <h3 class="card-title">Próximos Eventos</h3>
                <div class="activities-list" id="upcoming-activities">
                    <!-- Los eventos se cargan dinámicamente con JavaScript -->
                    <div class="text-center text-muted py-3">
                        <i class="bi bi-clock-history" style="font-size: 2rem;"></i><br>
                        Cargando eventos...
                    </div>
                </div>
                <div class="text-muted small mt-3">
                    <i class="bi bi-info-circle"></i> 
                    <a href="{% url 'calendario' %}" class="text-decoration-none">Ver todos los eventos en el calendario</a>
                </div>
            </div>
        </div>
    </div>
</div>


{% endblock %}

{% block extra_js %}
<!-- Bootstrap JS Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

<script>
// Variables globales
let currentDate = new Date();
let serverEvents = [];

// Elementos del DOM
const calendarGrid = document.getElementById('calendarGrid');
const currentMonthElement = document.getElementById('currentMonth');
const prevMonthBtn = document.getElementById('prevMonth');
const nextMonthBtn = document.getElementById('nextMonth');
const vacationDaysEl = document.getElementById('vacation-days');
const adminDaysEl = document.getElementById('admin-days');
const totalDaysEl = document.getElementById('total-days');
const upcomingActivitiesEl = document.getElementById('upcoming-activities');

// Nombres de meses en español
const monthNames = [
    'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
    'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
];

// Inicializar la aplicación
async function initDaysSystem() {
    await loadServerEvents();
    renderCalendar();
    loadUpcomingActivities();
    setupEventListeners();
}

// Configurar event listeners
function setupEventListeners() {
    if (prevMonthBtn) {
        prevMonthBtn.addEventListener('click', async () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            await renderCalendar();
        });
    }
    
    if (nextMonthBtn) {
        nextMonthBtn.addEventListener('click', async () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            await renderCalendar();
        });
    }
}

// Cargar eventos del servidor
async function loadServerEvents() {
    try {
        const response = await fetch('/api/eventos/');
        const data = await response.json();
        serverEvents = data.results || [];
        console.log('Eventos cargados desde el servidor:', serverEvents.length);
    } catch (error) {
        console.error('Error al cargar eventos:', error);
        serverEvents = [];
    }
}

// Renderizar calendario
async function renderCalendar() {
    if (!calendarGrid) return;
    
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    
    if (currentMonthElement) {
        currentMonthElement.textContent = `${monthNames[month]} ${year}`;
    }
    
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const daysInMonth = lastDay.getDate();
    
    calendarGrid.innerHTML = '';
    
    // Encabezados de días de la semana
    const dayOrder = ['L', 'M', 'M', 'J', 'V', 'S', 'D'];
    dayOrder.forEach(day => {
        const dayElement = document.createElement('div');
        dayElement.className = 'calendar-day-header';
        dayElement.textContent = day;
        calendarGrid.appendChild(dayElement);
    });
    
    const startingDay = firstDay.getDay();
    const adjustedStartingDay = startingDay === 0 ? 6 : startingDay - 1;
    
    // Días vacíos al inicio
    for (let i = 0; i < adjustedStartingDay; i++) {
        const emptyDay = document.createElement('div');
        emptyDay.className = 'calendar-day empty';
        calendarGrid.appendChild(emptyDay);
    }
    
    const today = new Date();
    
    // Días del mes
    for (let day = 1; day <= daysInMonth; day++) {
        const dayElement = document.createElement('div');
        dayElement.className = 'calendar-day';
        dayElement.textContent = day;
        
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        dayElement.dataset.date = dateStr;
    // Verificar si es hoy
    if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
    dayElement.classList.add('today');
    }
    // Verificar si hay eventos para este día
    const dayEvents = serverEvents.filter(event => event.fecha === dateStr);
    if (dayEvents.length > 0) {
        dayElement.classList.add('event-day');
        
        // Agregar indicador de tipo de evento
        const eventIndicator = document.createElement('div');
        eventIndicator.className = 'event-indicator';
        
        // Verificar el tipo de evento (prioridad: general > personal)
        const hasGeneralEvent = dayEvents.some(event => event.es_general);
        const hasPersonalEvent = dayEvents.some(event => !event.es_general);
        
        if (hasGeneralEvent) {
            eventIndicator.style.backgroundColor = '#FF6B6B';
        } else if (hasPersonalEvent) {
            eventIndicator.style.backgroundColor = '#3A8DFF';
        }
        
        eventIndicator.style.width = '8px';
        eventIndicator.style.height = '8px';
        eventIndicator.style.bottom = '4px';
        
        dayElement.appendChild(eventIndicator);
    }
    
    // Agregar event listener para redirigir al calendario
    dayElement.addEventListener('click', () => {
        window.location.href = '/calendario/';
    });
    
    calendarGrid.appendChild(dayElement);
}
}
    // Cargar próximos eventos desde el servidor
    async function loadUpcomingActivities() {
        try {
            if (serverEvents.length === 0) {
            await loadServerEvents();
            }
            if (!upcomingActivitiesEl) return;

            upcomingActivitiesEl.innerHTML = '';

            
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // Helper local
            const parseLocalDate = (s) => {
            const [y, m, d] = s.split('-').map(Number);
            return new Date(y, m - 1, d);
            };

            const futureEvents = serverEvents
            .filter(event => {
                if (!event.fecha) return false;
                const eventDate = parseLocalDate(event.fecha);
                eventDate.setHours(0, 0, 0, 0);
                return eventDate >= today;
            })
            .sort((a, b) => parseLocalDate(a.fecha) - parseLocalDate(b.fecha))
            .slice(0, 10); 

            if (futureEvents.length === 0) {
            upcomingActivitiesEl.innerHTML = `
                <div class="text-center text-muted py-3">
                <i class="bi bi-calendar-x" style="font-size: 2rem;"></i><br>
                No hay eventos próximos programados
                </div>
            `;
            return;
            }

            futureEvents.forEach(event => {
            const eventDate = parseLocalDate(event.fecha);
            const month = monthNames[eventDate.getMonth()].substring(0, 3).toUpperCase();
            const day = eventDate.getDate();

            const isGeneral = !!event.es_general;
            const eventTypeClass = isGeneral ? 'text-danger' : 'text-primary';
            const eventTypeIcon = isGeneral ? 'fa-bullhorn' : 'fa-user';
            const eventTypeBadge = isGeneral ? 'General' : 'Personal';
            const eventTypeColor = isGeneral ? '#FF6B6B' : '#3A8DFF';
            const eventTypeBgColor = isGeneral ? '#ffebee' : '#e3f2fd';

            let timeDisplay = '';
            if (event.todo_el_dia) {
                timeDisplay = 'Todo el día';
            } else if (event.hora_inicio) {
                timeDisplay = event.hora_inicio.substring(0, 5);
                if (event.hora_fin) {
                timeDisplay += ` - ${event.hora_fin.substring(0, 5)}`;
                }
            }

            const activityItem = document.createElement('div');
            activityItem.className = 'activity-item';
            activityItem.style.cursor = 'pointer';
            activityItem.onclick = () => window.location.href = '/calendario/';

            activityItem.innerHTML = `
                <div class="activity-date" style="background: ${eventTypeBgColor};">
                <span class="activity-month" style="color: ${eventTypeColor};">${month}</span>
                <span class="activity-day" style="color: ${eventTypeColor};">${day}</span>
                </div>
                <div style="flex: 1;">
                <div class="fw-semibold d-flex align-items-center gap-2 flex-wrap">
                    <i class="fas ${eventTypeIcon} ${eventTypeClass}"></i>
                    <span>${event.titulo}</span>
                    <span style="
                    font-size: 0.7rem;
                    padding: 3px 10px;
                    border-radius: 12px;
                    background: ${eventTypeBgColor};
                    color: ${eventTypeColor};
                    font-weight: 600;
                    ">${eventTypeBadge}</span>
                </div>
                <div class="text-muted small mt-1">
                    <i class="far fa-clock"></i> ${timeDisplay}
                    ${event.ubicacion ? `<br><i class="fas fa-map-marker-alt"></i> ${event.ubicacion}` : ''}
                </div>
                </div>
            `;

            upcomingActivitiesEl.appendChild(activityItem);
            });
        } catch (error) {
            console.error('Error al cargar próximos eventos:', error);
            if (upcomingActivitiesEl) {
            upcomingActivitiesEl.innerHTML = `
                <div class="text-center text-muted py-3">
                <i class="bi bi-exclamation-triangle" style="font-size: 2rem;"></i><br>
                Error al cargar eventos
                </div>
            `;
            }
        }
}

// Actualizar contadores de días
function updateDayCounts() {
if (vacationDaysEl) vacationDaysEl.textContent = "{{ vacation_days|default:0}}";
if (adminDaysEl) adminDaysEl.textContent = "{{ admin_days|default:0 }}";
if (totalDaysEl) totalDaysEl.textContent = "{{ total_days|default:0 }}";
}
// Inicializar el sistema cuando el DOM esté listo
document.addEventListener('DOMContentLoaded', () => {
initDaysSystem();
updateDayCounts();
});
</script>
{% endblock %}