{% extends "base/base.html" %}
{% load static %}

{% block title %}Inicio — Intranet CESFAM{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/index.css' %}">
{% endblock %}

{% block content %}
<div class="dashboard-container">
    
    <!-- BANNER COMPACTO -->
    <section class="welcome-banner">
        {% with nombre=usuario.nombre|default:request.session.usuario_nombre %}
        <h2 class="welcome-banner__title">
            ¡Bienvenido/a, {{ nombre|default:"Funcionario/a" }}!
        </h2>
        {% endwith %}
        <p class="welcome-banner__subtitle">
            Su espacio de gestión y comunicación interna del CESFAM Santa Rosa
        </p>
    </section>
    
    <!-- LAYOUT PRINCIPAL EQUILIBRADO -->
    <div class="dashboard-layout">
        
        <!-- COLUMNA PRINCIPAL -->
        <div class="dashboard-main">
            
            <!-- RESUMEN PERSONAL -->
            <section class="card card--summary">
                <header class="card__header">
                    <h3 class="card__title">Mi Resumen</h3>
                    <a href="{% url 'perfil' %}" class="card__action-link">Ver Perfil</a>
                </header>
                
                <div class="summary-grid">
                    <div class="summary-item summary-item--admin">
                        <div class="summary-item__label">Mi Rol</div>
                        <div class="summary-item__value">{{ rol|default:"Funcionario" }}</div>
                        <div class="summary-item__description">Centro de Salud Familiar</div>
                    </div>
                    
                    <div class="summary-item summary-item--vacation">
                        <div class="summary-item__label">Días Disponibles</div>
                        <div class="summary-item__value">15</div>
                        <div class="summary-item__description">Vacaciones este año</div>
                    </div>
                </div>
            </section>
            
            <!-- COMUNICADOS RECIENTES -->
            <section class="card card--announcements">
                <header class="card__header">
                    <h3 class="card__title">Comunicados Recientes</h3>
                    <a href="{#{% url 'comunicados' %}"#} class="card__action-link"> Ver todos</a>
                </header>
                
                <div class="announcements-list">
                    {% if avisos %}
                        {% for aviso in avisos %}
                            <a href="#" class="announcement-item">
                                <div class="announcement-item__title">{{ aviso.titulo }}</div>
                                <div class="announcement-item__meta">
                                    {{ aviso.fecha_registro|date:"d M Y" }} • 
                                    {{ aviso.id_usuario.nombre|default:"Dirección" }}
                                </div>
                            </a>
                        {% endfor %}
                    {% else %}
                        <div class="announcement-item">
                            <div class="announcement-item__title">No hay comunicados recientes</div>
                            <div class="announcement-item__meta">Los nuevos avisos aparecerán aquí</div>
                        </div>
                    {% endif %}
                </div>
            </section>
            
            <!-- SOLICITUDES -->
            <section class="card card--solicitudes">
                <header class="card__header">
                    <h3 class="card__title">Estado de Solicitudes</h3>
                    <a href="{% url 'lista_solicitudes' %}" class="card__action-link">Ver todas</a>
                </header>
                
                <div class="summary-grid">
                    <div class="summary-item" style="background: linear-gradient(135deg, #e3f2fd 0%, #f5f5f5 100%); border-left-color: #448fda;">
                        <div class="summary-item__label">Recibidas</div>
                        <div class="summary-item__value" style="color: #448fda;">{{ solicitudes_recibidas|default:"0" }}</div>
                        <div class="summary-item__description">Total este mes</div>
                    </div>
                    
                    <div class="summary-item" style="background: linear-gradient(135deg, #fff3e0 0%, #f5f5f5 100%); border-left-color: #ff9800;">
                        <div class="summary-item__label">Pendientes</div>
                        <div class="summary-item__value" style="color: #ff9800;">{{ solicitudes_pendientes|default:"0" }}</div>
                        <div class="summary-item__description">En revisión</div>
                    </div>
                    
                    <div class="summary-item" style="background: linear-gradient(135deg, #e8f5e8 0%, #f5f5f5 100%); border-left-color: #4caf50;">
                        <div class="summary-item__label">Aceptadas</div>
                        <div class="summary-item__value" style="color: #4caf50;">{{ solicitudes_aceptadas|default:"0" }}</div>
                        <div class="summary-item__description">Este período</div>
                    </div>
                    
                    <div class="summary-item" style="background: linear-gradient(135deg, #ffebee 0%, #f5f5f5 100%); border-left-color: #f44336;">
                        <div class="summary-item__label">Rechazadas</div>
                        <div class="summary-item__value" style="color: #f44336;">{{ solicitudes_rechazadas|default:"0" }}</div>
                        <div class="summary-item__description">Este período</div>
                    </div>
                </div>
            </section>
        </div>
        
        <!-- SIDEBAR -->
        <div class="dashboard-sidebar">
            
            <!-- CALENDARIO FUNCIONAL -->
            <section class="card card--calendar">
                <header class="card__header">
                    <h3 class="card__title">Calendario</h3>
                    <a href="{% url 'calendario' %}" class="card__action-link">Ver completo</a>
                </header>
                
                <div class="calendar-mini" id="calendar-mini">
                    <!-- El calendario se generará con JavaScript -->
                    <div class="calendar-header">
                        <button id="prev-month" class="calendar-nav">‹</button>
                        <h4 id="current-month">Octubre 2025</h4>
                        <button id="next-month" class="calendar-nav">›</button>
                    </div>
                    <div class="calendar-grid" id="calendar-grid">
                        <!-- Días generados dinámicamente -->
                    </div>
                </div>
            </section>
            
            <!-- PRÓXIMAS ACTIVIDADES -->
            <section class="card card--calendar">
                <header class="card__header">
                    <h3 class="card__title">Próximas Actividades</h3>
                    <span class="card__action-link">{{ eventos_proximos|default:"0" }} eventos</span>
                </header>
                
                <div class="calendar-list">
                    <div class="calendar-item">
                        <div class="calendar-item__date">
                            <span class="calendar-item__month">Oct</span>
                            <span class="calendar-item__day">05</span>
                        </div>
                        <div class="calendar-item__info">
                            <div class="calendar-item__title">Reunión General de Equipo</div>
                            <div class="calendar-item__time">09:00 - 11:00</div>
                        </div>
                    </div>
                    
                    <div class="calendar-item">
                        <div class="calendar-item__date">
                            <span class="calendar-item__month">Oct</span>
                            <span class="calendar-item__day">08</span>
                        </div>
                        <div class="calendar-item__info">
                            <div class="calendar-item__title">Capacitación SOME Digital</div>
                            <div class="calendar-item__time">14:00 - 16:00</div>
                        </div>
                    </div>
                    
                    <div class="calendar-item">
                        <div class="calendar-item__date">
                            <span class="calendar-item__month">Oct</span>
                            <span class="calendar-item__day">15</span>
                        </div>
                        <div class="calendar-item__info">
                            <div class="calendar-item__title">Evaluación Trimestral</div>
                            <div class="calendar-item__time">10:00 - 12:00</div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>
    
    <!-- SOPORTE -->
    <section class="support-card">
        <h3 class="support-card__title">¿Necesitas ayuda?</h3>
        <p class="support-card__description">
            Nuestro equipo de soporte está disponible para asistirte con cualquier problema o consulta que tengas.
        </p>
        <button class="support-card__button">
            <i data-lucide="headphones"></i>
            Contactar Soporte
        </button>
    </section>
</div>

<!-- JavaScript para el calendario funcional -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Calendario funcional
        const calendarGrid = document.getElementById('calendar-grid');
        const currentMonthElement = document.getElementById('current-month');
        const prevMonthBtn = document.getElementById('prev-month');
        const nextMonthBtn = document.getElementById('next-month');
        
        let currentDate = new Date();
        
        function renderCalendar(date) {
            const year = date.getFullYear();
            const month = date.getMonth();
            
            // Actualizar el título del mes
            const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
                                "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            currentMonthElement.textContent = `${monthNames[month]} ${year}`;
            
            // Obtener primer día del mes y último día
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            
            // Días de la semana
            const dayNames = ["L", "M", "M", "J", "V", "S", "D"];
            
            // Limpiar calendario
            calendarGrid.innerHTML = '';
            
            // Añadir encabezados de días
            dayNames.forEach(day => {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day-header';
                dayElement.textContent = day;
                calendarGrid.appendChild(dayElement);
            });
            
            // Añadir días vacíos al inicio
            const startingDay = firstDay.getDay();
            // Ajustar para que la semana empiece en lunes
            const adjustedStartingDay = startingDay === 0 ? 6 : startingDay - 1;
            
            for (let i = 0; i < adjustedStartingDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day empty';
                calendarGrid.appendChild(emptyDay);
            }
            
            // Añadir días del mes
            const today = new Date();
            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                dayElement.textContent = day;
                
                // Marcar el día actual
                if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                    dayElement.classList.add('today');
                }
                
                calendarGrid.appendChild(dayElement);
            }
        }
        
        // Navegación del calendario
        prevMonthBtn.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar(currentDate);
        });
        
        nextMonthBtn.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar(currentDate);
        });
        
        // Inicializar calendario
        renderCalendar(currentDate);
        
        // Inicializar iconos de Lucide
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    });
</script>

<!-- Estilos específicos para el calendario funcional -->
<style>
    .calendar-mini {
        background: white;
        border-radius: var(--radius);
        padding: 1rem;
    }
    
    .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }
    
    .calendar-header h4 {
        margin: 0;
        font-size: 1rem;
        font-weight: 600;
        color: var(--text);
    }
    
    .calendar-nav {
        background: none;
        border: none;
        font-size: 1.25rem;
        cursor: pointer;
        color: var(--muted);
        padding: 0.25rem 0.5rem;
        border-radius: var(--radius-sm);
        transition: var(--transition);
    }
    
    .calendar-nav:hover {
        background: var(--border);
        color: var(--text);
    }
    
    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 0.25rem;
    }
    
    .calendar-day-header {
        text-align: center;
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--muted);
        padding: 0.5rem 0;
    }
    
    .calendar-day {
        aspect-ratio: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: var(--radius-sm);
        font-size: 0.875rem;
        color: var(--text);
        cursor: pointer;
        transition: var(--transition);
    }
    
    .calendar-day:hover {
        background: var(--border);
    }
    
    .calendar-day.today {
        background: var(--primary);
        color: white;
        font-weight: 600;
    }
    
    .calendar-day.empty {
        background: transparent;
        cursor: default;
    }
    
    .calendar-day.empty:hover {
        background: transparent;
    }
</style>
{% endblock %}